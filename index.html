<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dine Scout</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; position: relative; }
    .map-container { position: relative; background: #0f172a; flex: 1; }
    #map { width: 100%; height: 100%; }
    #webOverlay { z-index: 500 !important; }

    /* Floating title */
    .app-title {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1002;
      color: #f1f5f9;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    /* Floating filter panel (Google Maps style) */
    .filter-panel {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 360px;
      background: #1a2332;
      border: 1px solid #2a3041;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 0;
      max-height: 73vh;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-panel.collapsed { width: 48px; }
    .filter-panel.collapsed .filter-content { display: none; }
    .filter-panel.collapsed .filter-toggle { border-radius: 12px; }

    .filter-toggle {
      padding: 14px;
      background: transparent;
      border: none;
      color: #cbd5e1;
      font-size: 16px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 12px 0 0 12px;
      transition: all 0.2s;
    }

    .filter-toggle:hover {
      background: #2a3041;
      color: #f1f5f9;
    }

    .filter-panel.collapsed .filter-toggle { display: flex; }

    .filter-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .filter-content::-webkit-scrollbar { width: 6px; }
    .filter-content::-webkit-scrollbar-track { background: transparent; }
    .filter-content::-webkit-scrollbar-thumb { background: #2a3041; border-radius: 3px; }
    .filter-content::-webkit-scrollbar-thumb:hover { background: #3a4051; }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2a3041;
    }

    .filter-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .filter-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .filter-close:hover {
      color: #f1f5f9;
    }

    .filter-section {
      margin-bottom: 14px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-section h3 {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      color: #94a3b8;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .search-box, .dropdown {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #2a3041;
      border-radius: 8px;
      font-size: 13px;
      background: #0f172a;
      color: #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .search-box::placeholder { color: #64748b; }
    .search-box:focus, .dropdown:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), inset 0 0 0 1px rgba(59, 130, 246, 0.2);
      background: #1a2332;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 5px 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .checkbox-item:hover {
      background: #2a3041;
      opacity: 1;
    }
    .checkbox-item input {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #3b82f6;
      flex-shrink: 0;
    }
    .checkbox-item label {
      cursor: pointer;
      font-size: 13px;
      color: #cbd5e1;
    }

    .checkbox-group.max-height {
      max-height: 140px;
      overflow-y: auto;
    }
    .checkbox-group.max-height::-webkit-scrollbar { width: 6px; }
    .checkbox-group.max-height::-webkit-scrollbar-track { background: transparent; border-radius: 3px; }
    .checkbox-group.max-height::-webkit-scrollbar-thumb { background: #2a3041; border-radius: 3px; }
    .checkbox-group.max-height::-webkit-scrollbar-thumb:hover { background: #3a4051; }

    .results-count {
      padding: 12px;
      background: #0f172a;
      border: 1px solid #2a3041;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #60a5fa;
    }

    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      width: 100%;
      letter-spacing: 0.3px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:active { transform: translateY(0); }

    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-random {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    .btn-random:hover {
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-secondary {
      background: #2a3041;
      color: #e2e8f0;
      border: 1px solid #3b82f6;
    }
    .btn-secondary:hover {
      background: #3a4051;
      border-color: #60a5fa;
    }

    /* New Analytics Panel */
    .analytics-panel {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 350px;
      max-height: 95vh;
      background: #1a2332;
      border: 1px solid #2a3041;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 900;
      display: flex;
      flex-direction: column;
      transform: translateX(400px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .analytics-panel.visible {
      transform: translateX(0);
    }

    .analytics-panel .analytics-header {
      padding: 16px 20px;
      border-bottom: 1px solid #2a3041;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .analytics-panel h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .analytics-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s;
    }

    .analytics-close:hover {
      color: #f1f5f9;
    }

    .analytics-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .analytics-body::-webkit-scrollbar {
      width: 6px;
    }

    .analytics-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .analytics-body::-webkit-scrollbar-thumb {
      background: #2a3041;
      border-radius: 3px;
    }

    .analytics-body::-webkit-scrollbar-thumb:hover {
      background: #3a4051;
    }

    .stat-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .stat {
      background: #0f172a;
      border: 1px solid #2a3041;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #3b82f6;
      margin: 4px 0;
    }

    .stat-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .analytics-btn {
      position: fixed;
      bottom: 40px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #1a2332;
      border: 2px solid #2a3041;
      color: #cbd5e1;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 800;
      padding: 0;
    }

    .analytics-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      border-color: #3b82f6;
    }

    .analytics-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    }

    .toggle-buttons {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      gap: 8px;
      z-index: 1001;
      pointer-events: none;
    }
    .toggle-buttons .toggle-btn {
      pointer-events: auto;
    }

    .toggle-btn {
      padding: 8px 12px;
      background: #1a2332;
      border: 1px solid #2a3041;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: #cbd5e1;
      white-space: nowrap;
    }
    .toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border-color: #3b82f6;
    }
    .toggle-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a2332;
      padding: 48px;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      text-align: center;
      z-index: 9999;
      border: 1px solid #2a3041;
    }
    .loading p { color: #cbd5e1; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #2a3041;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-message {
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #7f1d1d;
      border: 1px solid #b91c1c;
      color: #fecaca;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 9998;
      max-width: 500px;
    }
    .hidden { display: none !important; }

    .popup-name { font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #f1f5f9; }
    .popup-info { margin: 6px 0; color: #cbd5e1; font-size: 13px; }
    .popup-grade { display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: 700; font-size: 11px; margin-top: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .grade-a { background: #10b981; color: white; }
    .grade-b { background: #f59e0b; color: white; }
    .grade-c { background: #ef4444; color: white; }
    .popup-link { display: inline-block; margin-top: 12px; padding: 8px 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 600; transition: all 0.2s; }
    .popup-link:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

    /* Leaflet popup dark theme */
    .leaflet-popup-content-wrapper { background: #1a2332 !important; color: #e2e8f0 !important; border: 1px solid #2a3041 !important; border-radius: 8px !important; }
    .leaflet-popup-content { color: #e2e8f0 !important; margin: 16px !important; }
    .leaflet-popup-tip { background: #1a2332 !important; border: 1px solid #2a3041 !important; }

    /* Selected restaurant panel */
    .selected-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(26, 35, 50, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
      backdrop-filter: blur(10px);
      border-top: 1px solid #2a3041;
      padding: 24px;
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 50vh;
      overflow-y: auto;
    }
    .selected-panel.visible { transform: translateY(0); }
    .selected-panel h2 { font-size: 24px; margin-bottom: 12px; color: #f1f5f9; }
    .selected-panel .selected-info { display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start; }
    .selected-panel .selected-details { display: flex; flex-direction: column; gap: 8px; }
    .selected-panel .selected-actions { display: flex; flex-direction: column; gap: 12px; }
    .selected-panel .detail-item { color: #cbd5e1; font-size: 14px; }
    .selected-panel .detail-item strong { color: #94a3b8; }
    .selected-panel .close-btn { position: absolute; top: 16px; right: 16px; background: transparent; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
    .selected-panel .close-btn:hover { background: #2a3041; color: #f1f5f9; }

    /* Restaurant list view */
    .restaurant-list {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      border-top: 1px solid #2a3041;
      max-height: 40vh;
      overflow-y: auto;
      z-index: 999;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      padding: 20px;
    }
    .restaurant-list.visible { transform: translateY(0); }
    .restaurant-card { background: #1a2332; border: 1px solid #2a3041; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s; }
    .restaurant-card:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
    .restaurant-card.selected { border-color: #3b82f6; background: linear-gradient(135deg, #1a2332 0%, #1e3a5f 100%); box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4); }
    .restaurant-card h3 { font-size: 16px; margin-bottom: 8px; color: #f1f5f9; }
    .restaurant-card .card-info { font-size: 12px; color: #94a3b8; margin: 4px 0; }

    /* Navigation controls */
    .nav-controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 501; }
    .nav-btn { padding: 12px 20px; background: #1a2332; border: 1px solid #2a3041; border-radius: 8px; color: #cbd5e1; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .nav-btn:hover:not(:disabled) { background: #2a3041; border-color: #3b82f6; color: #f1f5f9; transform: translateY(-2px); }
    .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .leaflet-top, .leaflet-bottom {
      z-index: 400;
    }

    /* Insights Carousel */
    .insights-carousel {
      position: absolute;
      top: 16px;
      right: 16px;
      max-width: 380px;
      width: calc(100% - 32px);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      pointer-events: auto;
    }
    .insights-carousel.hidden {
      display: none;
    }
    .insight-text {
      font-size: 14px;
      line-height: 1.5;
      color: #e2e8f0;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .insight-counter {
      font-size: 11px;
      color: #94a3b8;
      text-align: right;
      margin-top: 8px;
      font-style: italic;
    }
    .carousel-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
    }
    .carousel-dots {
      display: flex;
      gap: 4px;
      flex: 1;
      justify-content: center;
    }
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(94, 165, 239, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }
    .dot.active {
      background: #3b82f6;
      width: 16px;
      border-radius: 3px;
    }
    .carousel-arrow {
      background: transparent;
      border: none;
      color: #3b82f6;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel-arrow:hover {
      color: #60a5fa;
      transform: scale(1.2);
    }

    /* Onboarding Modal */
    .onboarding-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }
    .onboarding-overlay.hidden {
      display: none;
    }
    .onboarding-modal {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(26, 35, 50, 0.95) 50%, rgba(15, 23, 42, 0.95) 100%),
                  url('Back1.png') center/cover no-repeat;
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 20px 80px rgba(59, 130, 246, 0.3), 0 0 60px rgba(59, 130, 246, 0.15);
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .onboarding-content {
      padding: 60px 50px;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      z-index: 10;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.75) 0%, rgba(15, 23, 42, 0.85) 50%, rgba(15, 23, 42, 0.75) 100%);
    }
    .onboarding-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }
    .onboarding-title {
      font-size: 32px;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }
    .onboarding-subtitle {
      font-size: 16px;
      color: #e2e8f0;
      line-height: 1.6;
      margin-bottom: 20px;
      max-width: 500px;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
    }
    .onboarding-highlight {
      color: #60a5fa;
      font-weight: 600;
    }
    .onboarding-features {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 30px;
      width: 100%;
      max-width: 450px;
      position: relative;
      z-index: 11;
    }
    .onboarding-feature {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.1) 100%);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      padding: 16px;
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.5;
      backdrop-filter: blur(4px);
      transition: all 0.3s;
    }
    .onboarding-feature:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.15) 100%);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }
    .onboarding-feature-icon {
      font-size: 24px;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }
    .onboarding-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 50px;
      border-top: 1px solid rgba(59, 130, 246, 0.3);
      gap: 12px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.5) 0%, rgba(15, 23, 42, 0.7) 100%);
      backdrop-filter: blur(6px);
      position: relative;
      z-index: 10;
    }
    .onboarding-nav {
      display: flex;
      gap: 8px;
    }
    .onboarding-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.3);
      cursor: pointer;
      transition: all 0.3s;
    }
    .onboarding-dot.active {
      background: #3b82f6;
      width: 24px;
      border-radius: 4px;
    }
    .onboarding-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      z-index: 12;
    }
    .onboarding-btn-secondary {
      background: linear-gradient(135deg, rgba(26, 35, 50, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
      color: #94a3b8;
      border: 1px solid rgba(59, 130, 246, 0.2);
      backdrop-filter: blur(4px);
    }
    .onboarding-btn-secondary:hover {
      background: linear-gradient(135deg, rgba(42, 48, 66, 0.9) 0%, rgba(26, 35, 50, 0.9) 100%);
      color: #cbd5e1;
      border-color: rgba(59, 130, 246, 0.4);
      transform: translateY(-1px);
    }
    .onboarding-btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    .onboarding-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }
    .onboarding-progress {
      font-size: 12px;
      color: #94a3b8;
    }

    /* Fork & Knife Drop Animation */
    .utensil-drop {
      position: fixed;
      top: -120px;
      left: 50%;
      font-size: 100px;
      z-index: 10001;
      pointer-events: none;
      transform: translateX(-50%);
      opacity: 0;
    }

    .fork-drop {
      animation: forkFall 0.8s ease-in forwards;
      margin-left: -60px;
    }

    .knife-drop {
      animation: knifeFall 0.8s ease-in forwards;
      margin-left: 60px;
      animation-delay: 0.05s;
    }

    @keyframes forkFall {
      0% {
        top: -180px;
        opacity: 1;
      }
      80% {
        top: 50%;
        opacity: 1;
      }
      90% {
        top: 50%;
        opacity: 1;
      }
      100% {
        top: 50%;
        opacity: 0;
      }
    }

    @keyframes knifeFall {
      0% {
        top: -180px;
        opacity: 1;
      }
      80% {
        top: 50%;
        opacity: 1;
      }
      90% {
        top: 50%;
        opacity: 1;
      }
      100% {
        top: 50%;
        opacity: 0;
      }
    }

    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      /* Keep filter panel visible but narrower */
      .filter-panel {
        width: 280px;
        max-height: 60vh;
        top: 12px;
        left: 8px;
        z-index: 1002;
      }

      /* Keep toggle buttons horizontal but move lower to avoid overlap */
      .toggle-buttons {
        flex-direction: row;
        gap: 6px;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        flex-wrap: wrap;
        justify-content: center;
        width: auto;
        max-width: 90%;
        z-index: 1000;
      }

      .toggle-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* Move insights carousel to bottom right */
      .insights-carousel {
        top: auto;
        bottom: 20px;
        right: 8px;
        left: auto;
        max-width: 300px;
        width: auto;
      }

      .insight-text {
        font-size: 12px;
        margin-bottom: 6px;
      }

      .carousel-nav {
        margin-top: 8px;
        gap: 6px;
      }

      /* App title - slightly smaller */
      .app-title {
        font-size: 20px;
        top: 40px;
      }

      /* Analytics sidebar - full width bottom sheet */
      .analytics-sidebar {
        width: 100% !important;
        max-width: 100%;
        right: 0 !important;
        left: 0 !important;
        bottom: 0 !important;
        top: auto;
        max-height: 55vh;
        border-radius: 16px 16px 0 0;
        z-index: 999;
      }

      /* Selected panel - full width on mobile */
      .selected-panel {
        max-height: 65vh;
        width: 100%;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 16px 16px 0 0;
      }

      /* Analytics panel - full width bottom sheet on mobile */
      .analytics-panel {
        position: fixed;
        bottom: 0;
        right: 0;
        left: 0;
        top: auto;
        width: 100%;
        max-height: 60vh;
        border-radius: 16px 16px 0 0;
        z-index: 999;
        transform: translateY(100%);
      }

      .analytics-panel.visible {
        transform: translateY(0);
      }

      .analytics-btn {
        bottom: 180px;
        right: 12px;
        z-index: 800;
      }
    }

    @media (max-width: 480px) {
      /* Extra small screens */
      .filter-panel {
        width: 260px;
        max-height: 55vh;
        top: 10px;
        left: 6px;
        z-index: 1002;
      }

      .filter-content {
        padding: 16px;
      }

      .toggle-buttons {
        top: 90px;
        gap: 5px;
        z-index: 1000;
      }

      .toggle-btn {
        padding: 5px 8px;
        font-size: 10px;
      }

      .app-title {
        font-size: 18px;
        top: 35px;
      }

      .insights-carousel {
        bottom: 16px;
        right: 6px;
        max-width: 280px;
        padding: 12px 16px;
      }

      .insight-text {
        font-size: 11px;
      }

      .onboarding-modal {
        max-width: 95%;
        max-height: 95vh;
      }

      .onboarding-content {
      padding: 60px 50px;
      }

      .onboarding-title {
        font-size: 24px;
      }

      .onboarding-subtitle {
        font-size: 14px;
      }

      .onboarding-features {
        grid-template-columns: 1fr;
      }
    }

  </style>

  <!-- Neighborhood typeahead list -->
  <datalist id="neighborhoodsList"></datalist>
</head>
<body>
  <!-- Utensil Drop Animation -->
  <div class="utensil-drop fork-drop" id="forkDrop" style="display: none;">üç¥</div>
  <div class="utensil-drop knife-drop" id="knifeDrop" style="display: none;">üî™</div>

  <!-- Onboarding Modal -->
  <div class="onboarding-overlay" id="onboardingOverlay">
    <div class="onboarding-modal" id="onboardingModal">
      <div class="onboarding-content" id="onboardingContent"></div>
      <div class="onboarding-footer">
        <div class="onboarding-nav" id="dotsNav"></div>
        <div class="onboarding-progress"><span id="progressText">1</span> / 5</div>
        <div>
          <button class="onboarding-btn onboarding-btn-secondary" id="onboardingSkip">Skip</button>
          <button class="onboarding-btn onboarding-btn-primary" id="onboardingNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="map-container">
      <div id="map"></div>
      <svg id="webOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none;"></svg>

      <!-- Floating title -->
      <div class="app-title">Dine Scout</div>

      <!-- Insights Carousel -->
      <div class="insights-carousel hidden" id="insightsCarousel">
        <div class="insight-text" id="insightText"></div>
        <div class="carousel-nav">
          <button class="carousel-arrow" id="prevInsight" title="Previous insight">‚Üê</button>
          <div class="carousel-dots" id="carouselDots"></div>
          <button class="carousel-arrow" id="nextInsight" title="Next insight">‚Üí</button>
        </div>
        <div class="insight-counter" id="insightCounter"></div>
      </div>

      <!-- Floating filter panel -->
      <div class="filter-panel" id="filterPanel">
        <button class="filter-toggle" id="filterToggle" title="Toggle filters">‚öôÔ∏è</button>
        <div class="filter-content">
          <div class="filter-header">
            <h2>Filters</h2>
            <button class="filter-close" id="filterClose">‚úï</button>
          </div>

          <div class="filter-section">
            <div class="results-count"><div id="resultsCount">Loading...</div></div>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" id="clearFiltersBtn">Clear All</button>
            <button class="btn btn-primary btn-random" id="randomBtn">üé≤ Random</button>
          </div>

          <div class="filter-section">
            <h3>Restaurant</h3>
            <input type="text" id="search" class="search-box" placeholder="Search by name...">
          </div>

          <div class="filter-section">
            <h3>Location</h3>
            <input type="text" id="locationSearch" class="search-box" list="neighborhoodsList" placeholder="Neighborhood or Zip...">
          </div>

          <div class="filter-section">
            <h3>Cuisine</h3>
            <input type="text" id="cuisineSearch" class="search-box" placeholder="Search cuisine...">
            <div class="checkbox-group max-height" id="cuisineCheckboxes"></div>
          </div>

          <div class="filter-section">
            <h3>Grade</h3>
            <div class="checkbox-group">
              <div class="checkbox-item"><input type="checkbox" id="gradeA" value="A" class="grade-checkbox"><label for="gradeA">A - Excellent</label></div>
              <div class="checkbox-item"><input type="checkbox" id="gradeB" value="B" class="grade-checkbox"><label for="gradeB">B - Good</label></div>
              <div class="checkbox-item"><input type="checkbox" id="gradeC" value="C" class="grade-checkbox"><label for="gradeC">C - Satisfactory</label></div>
            </div>
          </div>

          <div class="filter-section">
            <h3>Borough</h3>
            <div class="checkbox-group" id="boroughCheckboxes"></div>
          </div>
        </div>
      </div>

      <!-- Map controls (top center) -->
      <div class="toggle-buttons">
        <button class="toggle-btn active" id="markersToggle" title="Show markers">üìç Markers</button>
        <button class="toggle-btn" id="heatmapToggle" title="Show heatmap">üî• Heatmap</button>
        <button class="toggle-btn active" id="clusteringToggle" title="Toggle clustering">üéØ Cluster</button>
        <button class="toggle-btn" id="listViewToggle" title="Show list view">üìã List</button>
        <button class="toggle-btn" id="webToggle" title="Show food web">üï∏Ô∏è Web</button>
      </div>

      <!-- Navigation controls -->
      <div class="nav-controls hidden" id="navControls">
        <button class="nav-btn" id="prevBtn">‚Üê Previous</button>
        <button class="nav-btn" id="nextBtn">Next ‚Üí</button>
      </div>

      <!-- Selected restaurant panel (bottom) -->
      <div class="selected-panel" id="selectedPanel">
        <button class="close-btn" id="closePanel">√ó</button>
        <div id="selectedContent"></div>
      </div>

      <!-- Analytics Panel (top right) -->
      <div class="analytics-panel" id="analyticsPanel">
        <div class="analytics-header">
          <h3>üìä Stats</h3>
          <button class="analytics-close" id="analyticsCloseBtn">√ó</button>
        </div>
        <div class="analytics-body" id="analyticsBody">
          <p style="color: #94a3b8; padding: 20px; text-align: center;">Search or filter to see stats</p>
        </div>
      </div>

      <!-- Toggle button for analytics -->
      <button class="analytics-btn" id="analyticsToggleBtn" title="Show stats">üìä</button>

      <!-- Restaurant list view (bottom) -->
      <div class="restaurant-list" id="restaurantList"></div>
    </div>
  </div>

  <div id="loading" class="loading"><div class="spinner"></div><p>Loading restaurants...</p></div>
  <div id="errorMessage" class="error-message hidden"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <script>
    let allRestaurants = [], filteredRestaurants = [], map, markersLayer, clusterGroup, heatmapLayer;
    let isHeatmapMode = false, isClusteringEnabled = true, isListViewVisible = false, isWebMode = false;
    let selectedRestaurant = null, selectedIndex = -1;
    let restaurantMarkers = new Map(); // Store markers for quick lookup
    const boroughs = ['Manhattan', 'Bronx', 'Brooklyn', 'Queens', 'Staten Island'];
    const gradeColors = { 'A': '#10b981', 'B': '#f59e0b', 'C': '#ef4444' };

    // Cuisine colors for web visualization
    const cuisineColors = {
      'Italian': '#e74c3c', 'Chinese': '#f39c12', 'Japanese': '#e74c3c',
      'Mexican': '#27ae60', 'Indian': '#8e44ad', 'Thai': '#16a085',
      'Vietnamese': '#c0392b', 'Korean': '#2980b9', 'American': '#95a5a6',
      'French': '#d35400', 'Spanish': '#c0392b', 'Greek': '#3498db',
      'Turkish': '#e67e22', 'Lebanese': '#9b59b6', 'Brazilian': '#f1c40f',
      'Peruvian': '#e74c3c', 'Portuguese': '#e67e22', 'Caribbean': '#16a085',
      'African': '#8b4513', 'Middle Eastern': '#d35400', 'Filipino': '#c0392b',
      'Indonesian': '#27ae60', 'Malaysian': '#3498db', 'Singaporean': '#f39c12',
      'Pakistani': '#8e44ad', 'Bangladeshi': '#c0392b', 'Sri Lankan': '#27ae60',
      'Russian': '#95a5a6', 'Polish': '#e67e22', 'Eastern European': '#d35400',
      'Jewish': '#9b59b6', 'Mediterranean': '#16a085', 'Scandinavian': '#3498db',
      'German': '#95a5a6', 'Austrian': '#e67e22', 'Swiss': '#f39c12',
      'Vegetarian': '#27ae60', 'Vegan': '#16a085', 'Raw': '#2ecc71',
      'Gluten-Free': '#e74c3c', 'Kosher': '#3498db', 'Halal': '#8e44ad',
      'Seafood': '#3498db', 'Steakhouse': '#8b4513', 'Burger': '#e67e22',
      'Pizza': '#e74c3c', 'Pasta': '#f39c12', 'Sandwich': '#95a5a6',
      'Salad': '#27ae60', 'Soup': '#9b59b6', 'Dessert': '#f39c12',
      'Bakery': '#d35400', 'Coffee/Tea': '#8b4513', 'Juice': '#e74c3c',
      'Donuts': '#f39c12', 'Ice Cream': '#3498db', 'Cafe': '#d35400'
    };

    // --- Neighborhood <-> ZIP crosswalk (starter; extend as needed) ---
    const NEIGHBORHOOD_ZIPS = {
      // MANHATTAN
      "upper west side": ["10023","10024","10025"],
      "upper east side": ["10021","10028","10065","10075","10128"],
      "harlem": ["10026","10027","10030","10037","10039"],
      "east harlem": ["10029","10035"],
      "washington heights": ["10032","10033","10040"],
      "inwood": ["10034"],
      "chelsea": ["10001","10011"],
      "hells kitchen": ["10019","10036"],
      "midtown": ["10017","10018","10019","10020","10022"],
      "murray hill": ["10016"],
      "kips bay": ["10016"],
      "gramercy": ["10010"],
      "flatiron": ["10010","10011"],
      "greenwich village": ["10012","10014"],
      "west village": ["10014"],
      "east village": ["10003","10009"],
      "soho": ["10012"],
      "noho": ["10003","10012"],
      "nolita": ["10012"],
      "tribeca": ["10007","10013"],
      "chinatown": ["10002","10013"],
      "lower east side": ["10002"],
      "financial district": ["10004","10005","10006","10007","10038","10280","10282"],
      "battery park city": ["10280","10282"],
      "two bridges": ["10002"],

      // BROOKLYN
      "williamsburg": ["11211","11249"],
      "greenpoint": ["11222"],
      "bushwick": ["11207","11221","11237"],
      "bedford-stuyvesant": ["11205","11206","11216","11221","11233"],
      "clinton hill": ["11205"],
      "fort greene": ["11205","11217"],
      "downtown brooklyn": ["11201","11217"],
      "brooklyn heights": ["11201"],
      "dumbo": ["11201"],
      "boerum hill": ["11217"],
      "cobble hill": ["11201","11231"],
      "carroll gardens": ["11231"],
      "gowanus": ["11217","11231"],
      "park slope": ["11215"],
      "prospect heights": ["11238","11217"],
      "crown heights": ["11213","11216","11225","11233"],
      "prospect lefferts gardens": ["11225"],
      "flatbush": ["11226"],
      "kensington": ["11218"],
      "sunset park": ["11220","11232"],
      "bay ridge": ["11209"],
      "red hook": ["11231"],
      "sheepshead bay": ["11235"],
      "brighton beach": ["11235"],
      "canarsie": ["11236"],
      "brownsville": ["11212","11233"],

      // QUEENS
      "astoria": ["11102","11103","11105","11106"],
      "long island city": ["11101","11109"],
      "sunnyside": ["11104"],
      "woodside": ["11377"],
      "jackson heights": ["11372","11373"],
      "elmhurst": ["11373"],
      "flushing": ["11354","11355","11358"],
      "forest hills": ["11375"],
      "rego park": ["11374"],
      "jamaica": ["11432","11433","11435"],
      "ridgewood": ["11385"],
      "corona": ["11368"],
      "bayside": ["11360","11361","11364"],
      "rockaways": ["11691","11692","11693","11694","11697"],

      // BRONX
      "riverdale": ["10463","10471"],
      "kingsbridge": ["10463","10468"],
      "fordham": ["10458","10468"],
      "mott haven": ["10454","10455"],
      "melrose": ["10451","10455"],
      "south bronx": ["10451","10454","10455","10459"],
      "pelham bay": ["10461"],
      "throgs neck": ["10465"],
      "parkchester": ["10462"],
      "soundview": ["10472","10473"],
      "city island": ["10464"],

      // STATEN ISLAND
      "st. george": ["10301"],
      "stapleton": ["10304"],
      "tottenville": ["10307"],
      "great kills": ["10308"],
      "new dorp": ["10306"],
      "port richmond": ["10302"],
      "west brighton": ["10310"],
      "arden heights": ["10312"]
    };

    // Common shorthand / alt spellings
    const NEIGHBORHOOD_SYNONYMS = {
      "uws": "upper west side",
      "ues": "upper east side",
      "les": "lower east side",
      "fidi": "financial district",
      "wburg": "williamsburg",
      "lic": "long island city",
      "bed stuy": "bedford-stuyvesant",
      "bed-stuy": "bedford-stuyvesant",
      "bk heights": "brooklyn heights",
      "bpc": "battery park city",
      "ev": "east village",
      "wv": "west village",
      "tribecca": "tribeca"
    };

    const normalize = s => (s || "").toLowerCase().trim();
    const isZip = s => /^\d{5}$/.test(s);

    // Try to resolve a free-text location to a set of ZIPs + a display name
    function resolveLocationToZips(q) {
      const s = normalize(q);
      if (!s) return null;
      if (isZip(s)) return { name: s, zips: [s] };

      const base = NEIGHBORHOOD_SYNONYMS[s] || s;
      if (NEIGHBORHOOD_ZIPS[base]) return { name: titleCase(base), zips: NEIGHBORHOOD_ZIPS[base] };

      // loose partial match (e.g., "heights", "village", "ridge")
      const candidates = Object.keys(NEIGHBORHOOD_ZIPS).filter(k => k.includes(base) || base.includes(k));
      if (candidates.length) {
        const set = new Set();
        candidates.forEach(k => NEIGHBORHOOD_ZIPS[k].forEach(z => set.add(z)));
        const preferred = candidates.sort((a,b)=>a.length-b.length)[0];
        return { name: titleCase(preferred), zips: [...set] };
      }
      return null;
    }

    function titleCase(s) {
      return s.replace(/\b\w/g, c => c.toUpperCase());
    }

    function buildNeighborhoodDatalist() {
      const dl = document.getElementById('neighborhoodsList');
      dl.innerHTML = "";
      const names = Object.keys(NEIGHBORHOOD_ZIPS).sort();
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = titleCase(n);
        dl.appendChild(opt);
      });
    }
  
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }
  
    function showError(msg) {
      const el = document.getElementById('errorMessage');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

  
    // ---- Helpers for dates / history ----
    function parseDateSafe(s) {
      if (!s) return null;
      // NYC API dates like "2024-05-11T00:00:00.000"
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }
  
    function formatDateYYYYMMDD(d) {
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
      // --- NYC bounds, cuisine normalization, sane dates ---
    const NYC_BBOX = { minLat: 40.4774, maxLat: 40.9176, minLon: -74.2591, maxLon: -73.7004 };

    function inNYC(lat, lon) {
      return lat >= NYC_BBOX.minLat && lat <= NYC_BBOX.maxLat && lon >= NYC_BBOX.minLon && lon <= NYC_BBOX.maxLon;
    }

    const CUISINE_ALIAS = new Map([
      ['bakery products/desserts','Bakery'],
      ['caf√â','Cafe'], ['caf√©','Cafe'], ['cafe','Cafe'],
      ['coffee/tea','Coffee/Tea'], ['tea/coffee','Coffee/Tea'],
      ['pizzeria','Pizza'], ['pizza','Pizza'],
      ['bbq','Barbecue'], ['barbeque','Barbecue'], ['barbecue','Barbecue'],
      ['american','American'], ['chinese','Chinese'], ['japanese','Japanese'],
      ['italian','Italian'], ['mexican','Mexican'],
      ['unknown','Unknown']
    ]);

    function normCuisine(s, dba = '') {
      if (!s) return 'Unknown';
      let t = s.trim().toLowerCase().replace(/\s+/g,' ');
      t = CUISINE_ALIAS.get(t) ?? t.replace(/\b\w/g, c => c.toUpperCase());

      // Smart reclassification for overly-broad "American" category
      if (t === 'American' && dba) {
        const name = dba.toLowerCase();
        // Reclassify based on restaurant name keywords
        if (name.includes('burger') || name.includes('hamburger') || name.includes('beef')) return 'Burger';
        if (name.includes('steak') || name.includes('steakhouse')) return 'Steakhouse';
        if (name.includes('deli') || name.includes('sandwich') || name.includes('sub')) return 'Deli/Sandwich';
        if (name.includes('bbq') || name.includes('barbecue') || name.includes('ribs')) return 'Barbecue';
        if (name.includes('diner') || name.includes('coffee shop')) return 'Diner';
        if (name.includes('chicken') || name.includes('fried chicken')) return 'Fried Chicken';
        if (name.includes('seafood')) return 'Seafood';
        if (name.includes('wings') || name.includes('wing')) return 'Wings';
        // Keep generic "American" for the rest
      }
      return t;
    }

    // ignore bogus defaults; accept years [2000..next year]
    function saneDate(s) {
      if (!s) return null;
      const d = new Date(s);
      const nowY = new Date().getFullYear();
      if (isNaN(d) || d.getFullYear() < 2000 || d.getFullYear() > nowY + 1) return null;
      return d;
    }
    async function fetchData() {
  try {
    const res = await fetch('https://data.cityofnewyork.us/resource/43nn-pn8j.json?$limit=50000');
    if (!res.ok) throw new Error('Network error');
    const raw = await res.json();

    const nycBoros = new Set(['Manhattan', 'Bronx', 'Brooklyn', 'Queens', 'Staten Island']);

    // basic validity filter
    const valid = raw.filter(r => {
      const lat = parseFloat(r.latitude);
      const lon = parseFloat(r.longitude);
      return r.camis && r.dba && r.boro && nycBoros.has(r.boro)
        && Number.isFinite(lat) && Number.isFinite(lon)
        && lat !== 0 && lon !== 0 && inNYC(lat, lon);
    });
    // group by CAMIS; dedup dates same-day
    const byCamis = new Map();
    for (const r of valid) {
      const camis = r.camis;
      const lat = parseFloat(r.latitude);
      const lon = parseFloat(r.longitude);

      const entry = byCamis.get(camis) ?? {
        camis,
        dba: r.dba || 'Unknown',
        building: r.building || '',
        street: r.street || '',
        boro: r.boro,
        zipcode: r.zipcode || '',
        cuisine_description: normCuisine(r.cuisine_description || 'Unknown', r.dba || ''),
        lat, lon,
        dates: new Set(), // yyyy-mm-dd
        latestDate: null,
        grade: r.grade || null // kept if you still color markers by grade; ignore if not used
      };

      // keep freshest valid coords seen
      if (Number.isFinite(lat) && Number.isFinite(lon)) { entry.lat = lat; entry.lon = lon; }

      const dt = saneDate(r.inspection_date);
      if (dt) {
        const day = dt.toISOString().slice(0,10);
        entry.dates.add(day);
        if (!entry.latestDate || dt > entry.latestDate) entry.latestDate = dt;
      }

      // prefer non-empty address parts when missing
      if (!entry.building && r.building) entry.building = r.building;
      if (!entry.street && r.street) entry.street = r.street;
      if (!entry.zipcode && r.zipcode) entry.zipcode = r.zipcode;

      byCamis.set(camis, entry);
    }

    // finalize unique restaurants - only include those with valid grades
    allRestaurants = Array.from(byCamis.values())
      .filter(v => v.grade && v.grade !== null) // Only keep restaurants with actual grades
      .map(v => ({
        camis: v.camis,
        dba: v.dba,
        building: v.building,
        street: v.street,
        boro: v.boro,
        zipcode: v.zipcode,
        cuisine_description: v.cuisine_description,
        grade: v.grade,
        inspection_date: v.latestDate ? v.latestDate.toISOString().slice(0,10) : null,
        latitude: v.lat,
        longitude: v.lon,
        // compact history (dates only; feel free to drop if you don't need)
        date_history: Array.from(v.dates).sort().reverse()
      }));

    console.log(`Loaded ${allRestaurants.length} unique, cleaned restaurants (filtered by valid grades)`);
    return true;
  } catch (e) {
    console.error('Data fetch error:', e);
    showError('Failed to load data. Refresh page.');
    return false;
  }
}

    function initMap() {
      map = L.map('map').setView([40.7128, -74.0060], 11);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CartoDB',
        maxZoom: 19,
        subdomains: 'abcd'
      }).addTo(map);
  
      markersLayer = L.featureGroup();
  
      // Disable spiderfy animations on cluster click; just zoom to bounds
      clusterGroup = L.markerClusterGroup({
        spiderfyOnEveryClick: false,
        spiderfyOnMaxZoom: false,
        zoomToBoundsOnClick: true,
        showCoverageOnHover: false,
        disableClusteringAtZoom: 16
      });
  
      map.addLayer(markersLayer);
      map.addLayer(clusterGroup);
    }
  
    function gradeHistoryLine(history) {
      if (!history || history.length === 0) return '';
      // compact "A (2024-05-10) ‚Üí B (2023-11-02) ‚Üí A (2022-06-01)"
      const items = history.slice(0, 6).map(h => `${h.grade} (${h.date})`);
      const tail = history.length > 6 ? ' ‚Üí ‚Ä¶' : '';
      return items.join(' ‚Üí ') + tail;
    }
  
    function createMarker(r, isSelected = false) {
      const radius = isSelected ? 8 : 4;
      const marker = L.circleMarker([r.latitude, r.longitude], {
        radius: radius,
        fillColor: isSelected ? '#3b82f6' : (gradeColors[r.grade] || '#94a3b8'),
        color: 'transparent',
        weight: 0,
        opacity: 0,
        fillOpacity: isSelected ? 0.95 : 0.7,
        className: isSelected ? 'marker-highlight' : ''
      });
      const gUrl = `https://www.google.com/maps/search/${encodeURIComponent(r.dba + ' ' + r.building + ' ' + r.street)}`;
      const address = `${r.building} ${r.street}${r.zipcode ? ', ' + r.zipcode : ''}`;
      const gradeClass = r.grade ? `grade-${String(r.grade).toLowerCase()}` : '';
  
      const hist = gradeHistoryLine(r.grade_history);
      const inspected = r.grade_date || r.inspection_date;
  
      const p = `
        <div style="width:260px; color: #e2e8f0;">
          <div class="popup-name">${r.dba}</div>
          <div class="popup-info">${address}</div>
          <div class="popup-info"><strong>Cuisine:</strong> ${r.cuisine_description}</div>
          <div class="popup-info"><strong>Borough:</strong> ${r.boro}</div>
          ${r.grade ? `<div class="popup-grade ${gradeClass}">Grade ${r.grade}</div>` : ''}
          ${inspected ? `<div class="popup-info"><strong>Latest:</strong> ${inspected}</div>` : ''}
          ${hist ? `<div class="popup-info"><strong>Grade history:</strong><br>${hist}</div>` : ''}
          <a href="${gUrl}" target="_blank" class="popup-link">View on Google Maps</a>
        </div>`;
      marker.bindPopup(p);
      marker.on('click', () => selectRestaurant(r));
      // Store marker reference
      const markerKey = `${r.camis}`;
      if (!restaurantMarkers.has(markerKey)) {
        restaurantMarkers.set(markerKey, marker);
      }
      return marker;
    }
  
    function selectRestaurant(restaurant) {
      selectedRestaurant = restaurant;
      selectedIndex = filteredRestaurants.findIndex(r => r.camis === restaurant.camis);
  
      updateSelectedPanel();
      updateMap();
      updateRestaurantList();
      updateNavControls();
  
      map.setView([restaurant.latitude, restaurant.longitude], 16);
      document.getElementById('selectedPanel').classList.add('visible');
    }
  
    function updateSelectedPanel() {
      if (!selectedRestaurant) return;
      const panel = document.getElementById('selectedPanel');
      const content = document.getElementById('selectedContent');
      const gUrl = `https://www.google.com/maps/search/${encodeURIComponent(selectedRestaurant.dba + ' ' + selectedRestaurant.building + ' ' + selectedRestaurant.street)}`;
      const address = `${selectedRestaurant.building} ${selectedRestaurant.street}${selectedRestaurant.zipcode ? ', ' + selectedRestaurant.zipcode : ''}`;
      const gradeClass = selectedRestaurant.grade ? `grade-${String(selectedRestaurant.grade).toLowerCase()}` : '';
      const hist = gradeHistoryLine(selectedRestaurant.grade_history);
      const inspected = selectedRestaurant.grade_date || selectedRestaurant.inspection_date;
  
      // Adjust panel height if list view is visible
      panel.style.maxHeight = isListViewVisible ? '30vh' : '50vh';
  
      content.innerHTML = `
        <h2>${selectedRestaurant.dba}</h2>
        <div class="selected-info">
          <div class="selected-details">
            <div class="detail-item"><strong>Address:</strong> ${address}</div>
            <div class="detail-item"><strong>Cuisine:</strong> ${selectedRestaurant.cuisine_description}</div>
            <div class="detail-item"><strong>Borough:</strong> ${selectedRestaurant.boro}</div>
            ${selectedRestaurant.grade ? `<div class="popup-grade ${gradeClass}" style="display: inline-block; margin-top: 8px;">Grade ${selectedRestaurant.grade}</div>` : ''}
            ${inspected ? `<div class="detail-item"><strong>Latest:</strong> ${inspected}</div>` : ''}
            ${hist ? `<div class="detail-item"><strong>Grade history:</strong> ${hist}</div>` : ''}
          </div>
          <div class="selected-actions">
            <a href="${gUrl}" target="_blank" class="btn btn-primary" style="text-decoration: none; display: inline-block; text-align: center;">üìç View on Google Maps</a>
          </div>
        </div>
      `;
    }
  
    function updateRestaurantList() {
      const list = document.getElementById('restaurantList');
      if (!isListViewVisible) {
        list.classList.remove('visible');
        return;
      }
  
      list.innerHTML = '';
      filteredRestaurants.forEach((r, idx) => {
        const card = document.createElement('div');
        card.className = `restaurant-card ${selectedRestaurant && r.camis === selectedRestaurant.camis ? 'selected' : ''}`;
        card.innerHTML = `
          <h3>${r.dba}</h3>
          <div class="card-info">${r.cuisine_description}</div>
          <div class="card-info">${r.boro}${r.zipcode ? ' ‚Ä¢ ' + r.zipcode : ''}</div>
          ${r.grade ? `<div class="popup-grade grade-${String(r.grade).toLowerCase()}" style="display: inline-block; margin-top: 8px;">${r.grade}</div>` : ''}
        `;
        card.addEventListener('click', () => selectRestaurant(r));
        list.appendChild(card);
      });
      list.classList.add('visible');
    }
  
    function updateNavControls() {
      const navControls = document.getElementById('navControls');
      if (filteredRestaurants.length > 1 && selectedRestaurant) {
        navControls.classList.remove('hidden');
        document.getElementById('prevBtn').disabled = selectedIndex === 0;
        document.getElementById('nextBtn').disabled = selectedIndex === filteredRestaurants.length - 1;
      } else {
        navControls.classList.add('hidden');
      }
    }
  
    function navigateRestaurants(direction) {
      if (selectedIndex === -1 || filteredRestaurants.length === 0) return;
      const newIndex = direction === 'next' ? selectedIndex + 1 : selectedIndex - 1;
      if (newIndex >= 0 && newIndex < filteredRestaurants.length) {
        selectRestaurant(filteredRestaurants[newIndex]);
      }
    }
  
    function buildCuisineCheckboxes() {
      const counts = {};
      allRestaurants.forEach(r => {
        const cuisine = (r.cuisine_description || 'Unknown').trim();
        if (cuisine) counts[cuisine] = (counts[cuisine] || 0) + 1;
      });
  
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  
      const container = document.getElementById('cuisineCheckboxes');
      container.innerHTML = '';
  
      sorted.forEach(([cuisine, count]) => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `cuisine-${cuisine.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}`;
        cb.value = cuisine;
        cb.className = 'cuisine-checkbox';
        const lbl = document.createElement('label');
        lbl.htmlFor = cb.id;
        lbl.textContent = `${cuisine} (${count})`;
        div.appendChild(cb);
        div.appendChild(lbl);
        container.appendChild(div);
      });
    }
  
    function buildBoroughCheckboxes() {
      const container = document.getElementById('boroughCheckboxes');
      boroughs.forEach(b => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `borough-${b}`;
        cb.value = b;
        cb.className = 'borough-checkbox';
        const lbl = document.createElement('label');
        lbl.htmlFor = `borough-${b}`;
        lbl.textContent = b;
        div.appendChild(cb);
        div.appendChild(lbl);
        container.appendChild(div);
      });
    }
  
    function applyFilters() {
      const search = document.getElementById('search').value.toLowerCase();
      const locationRaw = document.getElementById('locationSearch').value;
      const resolved = resolveLocationToZips(locationRaw); // {name, zips} or null

      const cuisines = Array.from(document.querySelectorAll('.cuisine-checkbox:checked')).map(cb => cb.value);
      const grades = Array.from(document.querySelectorAll('.grade-checkbox:checked')).map(cb => cb.value);
      const boros = Array.from(document.querySelectorAll('.borough-checkbox:checked')).map(cb => cb.value);

      filteredRestaurants = allRestaurants.filter(r => {
        const matchesSearch = !search || r.dba.toLowerCase().includes(search);

        let matchesLocation = true;
        if (locationRaw && resolved) {
          matchesLocation = r.zipcode && resolved.zips.includes(String(r.zipcode));
        } else if (locationRaw && !resolved) {
          // Fallback to fuzzy address text if not a known neighborhood/zip
          const loc = locationRaw.toLowerCase();
          matchesLocation =
            (r.zipcode && r.zipcode.toString().toLowerCase().includes(loc)) ||
            (r.street && r.street.toLowerCase().includes(loc)) ||
            (r.building && r.building.toLowerCase().includes(loc)) ||
            ((r.building + ' ' + r.street).toLowerCase().includes(loc));
        }

        const matchesCuisine = cuisines.length === 0 || cuisines.includes(r.cuisine_description);
        const matchesGrade = grades.length === 0 || (r.grade && grades.includes(r.grade));
        const matchesBoro = boros.length === 0 || boros.includes(r.boro);

        return matchesSearch && matchesLocation && matchesCuisine && matchesGrade && matchesBoro;
      });

      // Stash the resolved location for UI message
      window.__lastResolvedLocation = resolved || null;

      updateMap();
      if (isWebMode) {
        renderFoodWeb();
      }
      updateResultsCount();
    }

    function updateMap() {
      // Skip marker/cluster rendering if in web mode
      if (isWebMode) {
        // Just redraw the web, don't show markers
        renderFoodWeb();
        return;
      }

      markersLayer.clearLayers();
      clusterGroup.clearLayers();
      restaurantMarkers.clear();

      if (isHeatmapMode) {
        if (heatmapLayer) map.removeLayer(heatmapLayer);
        const data = filteredRestaurants.map(r => [r.latitude, r.longitude, 1]);
        heatmapLayer = L.heatLayer(data, {
          radius: 25, blur: 15, maxZoom: 17,
          gradient: { 0.2: '#2563eb', 0.4: '#10b981', 0.6: '#f59e0b', 0.8: '#ef4444', 1: '#7c2d12' }
        });
        map.addLayer(heatmapLayer);
      } else {
        if (heatmapLayer) map.removeLayer(heatmapLayer);
        const markers = filteredRestaurants.map(r => {
          const isSelected = selectedRestaurant && r.camis === selectedRestaurant.camis;
          return createMarker(r, isSelected);
        });
        if (isClusteringEnabled) {
          markers.forEach(m => clusterGroup.addLayer(m));
        } else {
          markers.forEach(m => markersLayer.addLayer(m));
        }
        if (markers.length > 0 && !selectedRestaurant) {
          const g = new L.featureGroup(markers);
          map.fitBounds(g.getBounds(), { padding: [50, 50] });
        }
      }
    }
  
    function updateResultsCount() {
      const el = document.getElementById('resultsCount');
      const res = window.__lastResolvedLocation;
      if (res && res.zips && res.zips.length) {
        el.textContent = `Showing ${filteredRestaurants.length.toLocaleString()} restaurants in ${res.name} (ZIPs: ${res.zips.join(', ')})`;
      } else {
        el.textContent = `Showing ${filteredRestaurants.length.toLocaleString()} restaurants`;
      }
    }
  
    function clearFilters() {
      document.getElementById('search').value = '';
      document.getElementById('locationSearch').value = '';
      document.querySelectorAll('.cuisine-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('.grade-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('.borough-checkbox').forEach(cb => cb.checked = false);
      closeSelectedPanel();
      applyFilters();
      updateAnalytics();
    }
  
    function chooseRandom() {
      if (filteredRestaurants.length === 0) {
        showError('No restaurants match your filters. Try clearing filters first.');
        return;
      }
      const randomIndex = Math.floor(Math.random() * filteredRestaurants.length);
      const randomRestaurant = filteredRestaurants[randomIndex];
      selectRestaurant(randomRestaurant);
    }
  
    function toggleListView() {
      isListViewVisible = !isListViewVisible;
      document.getElementById('listViewToggle').classList.toggle('active', isListViewVisible);
      updateRestaurantList();
    }
  
    function closeSelectedPanel() {
      document.getElementById('selectedPanel').classList.remove('visible');
      selectedRestaurant = null;
      selectedIndex = -1;
      updateMap();
      updateRestaurantList();
      updateNavControls();
    }
  
    function toggleHeatmap() {
      isHeatmapMode = !isHeatmapMode;
      document.getElementById('markersToggle').classList.toggle('active', !isHeatmapMode);
      document.getElementById('heatmapToggle').classList.toggle('active', isHeatmapMode);
      updateMap();
    }
  
    function toggleClustering() {
      isClusteringEnabled = !isClusteringEnabled;
      document.getElementById('clusteringToggle').classList.toggle('active');
      if (!isHeatmapMode) updateMap();
    }

    function toggleWebMode() {
      isWebMode = !isWebMode;

      const toggle = document.getElementById('webToggle');
      const overlay = document.getElementById('webOverlay');

      if (toggle) {
        toggle.classList.toggle('active');
      }

      if (isWebMode) {
        // Hide markers and clusters when showing web
        if (markersLayer) markersLayer.clearLayers();
        if (clusterGroup) clusterGroup.clearLayers();

        if (overlay) {
          overlay.style.display = 'block';
        }
        renderFoodWeb();
        // Add map listeners for redrawing when map moves/zooms
        if (!window.webMapListenersAdded && map) {
          map.on('moveend', renderFoodWeb);
          map.on('zoomend', renderFoodWeb);
          window.webMapListenersAdded = true;
        }
      } else {
        // Show markers and clusters again when turning off web
        if (overlay) {
          overlay.style.display = 'none';
          // Clear the SVG to free memory
          overlay.innerHTML = '';
        }
        // Restore the markers
        updateMap();
      }
    }

    function getDistanceBetweenPoints(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // Distance in km
    }

    function getCuisineColor(cuisine) {
      // Map cuisines to distinct colors
      const colorMap = {
        'american': '#ff6b6b',
        'chinese': '#f74141',
        'italian': '#4ecdc4',
        'japanese': '#ff6b9d',
        'mexican': '#c44569',
        'pizza': '#ffa502',
        'thai': '#ffd166',
        'indian': '#ff8c42',
        'korean': '#d62828',
        'french': '#6a4c93',
        'spanish': '#e76f51',
        'greek': '#0099ff',
        'turkish': '#ff7f50',
        'vietnamese': '#52b788',
        'caribbean': '#d62828',
        'mediterranean': '#06a77d',
        'middle eastern': '#f79646',
        'asian': '#4a90e2',
        'seafood': '#3498db',
        'mediterranean-scandinavian': '#1abc9c',
        'barbecue': '#e74c3c',
        'sandwiches': '#e67e22',
        'coffee': '#8b6f47',
        'bakery': '#d4a574',
        'desserts': '#ff69b4',
        'vegetarian': '#27ae60',
        'vegan': '#52c41a'
      };

      // Check for exact match first
      if (colorMap[cuisine]) {
        return colorMap[cuisine];
      }

      // Check for partial matches
      for (const [key, color] of Object.entries(colorMap)) {
        if (cuisine.includes(key) || key.includes(cuisine)) {
          return color;
        }
      }

      // Hash-based color for unmapped cuisines
      let hash = 0;
      for (let i = 0; i < cuisine.length; i++) {
        hash = ((hash << 5) - hash) + cuisine.charCodeAt(i);
        hash = hash & hash;
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 70%, 50%)`;
    }

    function renderFoodWeb() {
      // Skip if web mode is not active (optimization)
      if (!isWebMode) {
        return;
      }

      const svg = document.getElementById('webOverlay');
      if (!svg) {
        return;
      }

      // Clear previous lines
      svg.innerHTML = '';

      if (filteredRestaurants.length === 0 || !map) {
        return;
      }

      const PROXIMITY_THRESHOLD_KM = 1;
      const GRID_SIZE = 0.02;
      const spatialGrid = {};
      const bounds = map.getBounds();

      // Only process restaurants within current view bounds + buffer
      const padding = 0.05;
      const viewBounds = {
        north: bounds.getNorth() + padding,
        south: bounds.getSouth() - padding,
        east: bounds.getEast() + padding,
        west: bounds.getWest() - padding
      };

      // Build spatial grid for efficiency - only for visible restaurants
      filteredRestaurants.forEach((restaurant, index) => {
        const lat = restaurant.latitude;
        const lng = restaurant.longitude;

        // Check if restaurant is within view bounds
        if (lat >= viewBounds.south && lat <= viewBounds.north &&
            lng >= viewBounds.west && lng <= viewBounds.east) {
          const gridKey = `${Math.floor(lat / GRID_SIZE)},${Math.floor(lng / GRID_SIZE)}`;
          if (!spatialGrid[gridKey]) spatialGrid[gridKey] = [];
          spatialGrid[gridKey].push(index);
        }
      });

      // Draw lines between nearby restaurants
      const checkedPairs = new Set();
      const visibleIndices = new Set();

      Object.values(spatialGrid).forEach(indices => {
        indices.forEach(idx => visibleIndices.add(idx));
      });

      visibleIndices.forEach(i => {
        const restaurant = filteredRestaurants[i];
        const gridX = Math.floor(restaurant.latitude / GRID_SIZE);
        const gridY = Math.floor(restaurant.longitude / GRID_SIZE);

        // Check this cell and 8 adjacent cells
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const neighborKey = `${gridX + dx},${gridY + dy}`;
            const neighbors = spatialGrid[neighborKey] || [];

            neighbors.forEach(j => {
              if (i < j) {
                const pairKey = `${i}-${j}`;
                if (!checkedPairs.has(pairKey)) {
                  checkedPairs.add(pairKey);
                  const r1 = filteredRestaurants[i];
                  const r2 = filteredRestaurants[j];
                  const distance = getDistanceBetweenPoints(r1.latitude, r1.longitude, r2.latitude, r2.longitude);

                  if (distance <= PROXIMITY_THRESHOLD_KM) {
                    // Get screen coordinates from Leaflet - use containerPoint for proper positioning
                    const p1 = map.latLngToContainerPoint([r1.latitude, r1.longitude]);
                    const p2 = map.latLngToContainerPoint([r2.latitude, r2.longitude]);

                    // Create SVG line
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', p1.x);
                    line.setAttribute('y1', p1.y);
                    line.setAttribute('x2', p2.x);
                    line.setAttribute('y2', p2.y);

                    // Lines with better visibility at all zoom levels
                    const opacity = Math.max(0.15, 1 - distance / PROXIMITY_THRESHOLD_KM);
                    const strokeWidth = Math.max(1.5, 2.5 * (1 - distance / PROXIMITY_THRESHOLD_KM));

                    // Color based on cuisine match
                    const cuisine1 = r1.cuisine_description.toLowerCase();
                    const cuisine2 = r2.cuisine_description.toLowerCase();
                    let lineColor = '#3b82f6'; // Default blue for different cuisines

                    if (cuisine1 === cuisine2) {
                      // Same cuisine - use a vibrant color
                      lineColor = getCuisineColor(cuisine1);
                    }

                    line.setAttribute('stroke', lineColor);
                    line.setAttribute('stroke-width', strokeWidth);
                    line.setAttribute('opacity', opacity);
                    line.setAttribute('stroke-linecap', 'round');

                    svg.appendChild(line);
                  }
                }
              }
            });
          }
        }
      });
    }

    function toggleFilterPanel() {
      const panel = document.getElementById('filterPanel');
      panel.classList.toggle('collapsed');
    }

    function filterCuisines(searchTerm) {
      const term = searchTerm.toLowerCase();
      const checkboxes = document.querySelectorAll('#cuisineCheckboxes .checkbox-item');
      checkboxes.forEach(item => {
        const label = item.querySelector('label');
        if (label) {
          const cuisineName = label.textContent.toLowerCase();
          item.style.display = cuisineName.includes(term) ? 'flex' : 'none';
        }
      });
    }

    // --- New Analytics System ---
    function toggleAnalyticsPanel() {
      const panel = document.getElementById('analyticsPanel');
      const btn = document.getElementById('analyticsToggleBtn');

      if (!panel.classList.contains('visible')) {
        // Opening analytics - close insights carousel
        const carousel = document.getElementById('insightsCarousel');
        if (carousel) carousel.classList.add('hidden');
      } else {
        // Closing analytics - reshow carousel
        const carousel = document.getElementById('insightsCarousel');
        if (carousel) carousel.classList.remove('hidden');
      }

      panel.classList.toggle('visible');
      btn.classList.toggle('active');
    }

    function updateAnalytics() {
      if (filteredRestaurants.length === 0) {
        document.getElementById('analyticsBody').innerHTML = '<p style="color: #94a3b8; padding: 20px; text-align: center;">No results to display</p>';
        return;
      }

      // Calculate stats
      const total = filteredRestaurants.length;
      const gradeA = filteredRestaurants.filter(r => r.grade === 'A').length;
      const gradeB = filteredRestaurants.filter(r => r.grade === 'B').length;
      const gradeC = filteredRestaurants.filter(r => r.grade === 'C').length;
      const gradeAPercent = ((gradeA / total) * 100).toFixed(0);
      const gradeBPercent = ((gradeB / total) * 100).toFixed(0);
      const gradeCPercent = ((gradeC / total) * 100).toFixed(0);

      // Unique cuisines
      const uniqueCuisines = new Set(filteredRestaurants.map(r => r.cuisine_description)).size;

      // Top cuisines (top 5)
      const cuisineCounts = {};
      filteredRestaurants.forEach(r => {
        cuisineCounts[r.cuisine_description] = (cuisineCounts[r.cuisine_description] || 0) + 1;
      });
      const topCuisines = Object.entries(cuisineCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const topCuisine = topCuisines[0];

      // Borough breakdown
      const boroughCounts = {};
      filteredRestaurants.forEach(r => {
        boroughCounts[r.boro] = (boroughCounts[r.boro] || 0) + 1;
      });
      const boroughs = Object.entries(boroughCounts).sort((a, b) => b[1] - a[1]);
      const topBorough = boroughs[0];

      // Build pie chart for grade distribution
      const gradeTotal = gradeA + gradeB + gradeC;
      const percentA = gradeTotal > 0 ? (gradeA / gradeTotal * 100) : 0;
      const percentB = gradeTotal > 0 ? (gradeB / gradeTotal * 100) : 0;
      const percentC = gradeTotal > 0 ? (gradeC / gradeTotal * 100) : 0;

      // Calculate SVG pie chart angles
      let currentAngle = 0;
      const angleA = (percentA / 100) * 360;
      const angleB = (percentB / 100) * 360;
      const angleC = (percentC / 100) * 360;

      const createPiePath = (startAngle, angle, radius = 35, cx = 50, cy = 50) => {
        const startRad = (startAngle * Math.PI) / 180;
        const endRad = ((startAngle + angle) * Math.PI) / 180;
        const x1 = cx + radius * Math.cos(startRad);
        const y1 = cy + radius * Math.sin(startRad);
        const x2 = cx + radius * Math.cos(endRad);
        const y2 = cy + radius * Math.sin(endRad);
        const largeArc = angle > 180 ? 1 : 0;
        return `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
      };

      const pieChart = `
        <div style="background: #0f172a; border: 1px solid #2a3041; border-radius: 8px; padding: 16px; margin-top: 12px;">
          <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; font-weight: 700;">Grade Distribution</div>
          <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
            <svg style="width: 120px; height: 120px;" viewBox="0 0 100 100">
              ${gradeA > 0 ? `<path d="${createPiePath(currentAngle, angleA)}" fill="#10b981" stroke="#0f172a" stroke-width="2"/>` : ''}
              ${gradeB > 0 ? `<path d="${createPiePath(currentAngle + angleA, angleB)}" fill="#f59e0b" stroke="#0f172a" stroke-width="2"/>` : ''}
              ${gradeC > 0 ? `<path d="${createPiePath(currentAngle + angleA + angleB, angleC)}" fill="#ef4444" stroke="#0f172a" stroke-width="2"/>` : ''}
            </svg>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                <span style="font-size: 12px; color: #cbd5e1;">Grade A: <strong style="color: #10b981;">${gradeA}</strong> (${percentA.toFixed(0)}%)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></div>
                <span style="font-size: 12px; color: #cbd5e1;">Grade B: <strong style="color: #f59e0b;">${gradeB}</strong> (${percentB.toFixed(0)}%)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></div>
                <span style="font-size: 12px; color: #cbd5e1;">Grade C: <strong style="color: #ef4444;">${gradeC}</strong> (${percentC.toFixed(0)}%)</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Additional metrics
      const diversityScore = (uniqueCuisines / total).toFixed(2);
      const topBoroughPercent = topBorough ? ((topBorough[1] / total) * 100).toFixed(0) : 0;
      const nonGradeAPercent = (100 - gradeAPercent);

      const html = `
        <div class="stat-row">
          <div class="stat">
            <div class="stat-label">Total</div>
            <div class="stat-value">${total}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Cuisines</div>
            <div class="stat-value">${uniqueCuisines}</div>
          </div>
        </div>

        <div class="stat-row">
          <div class="stat">
            <div class="stat-label">Grade A</div>
            <div class="stat-value" style="color: #10b981;">${gradeAPercent}%</div>
          </div>
          <div class="stat">
            <div class="stat-label">Top Borough</div>
            <div style="font-size: 14px; color: #cbd5e1; margin: 4px 0; font-weight: 600;">${topBorough ? topBorough[0] : 'N/A'}</div>
          </div>
        </div>

        <div class="stat-row">
          <div class="stat">
            <div class="stat-label">Diversity</div>
            <div class="stat-value" style="color: #60a5fa;">${diversityScore}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Borough %</div>
            <div class="stat-value" style="color: #a78bfa;">${topBoroughPercent}%</div>
          </div>
        </div>

        ${pieChart}

        <div style="background: #0f172a; border: 1px solid #2a3041; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 700;">Most Common Cuisine</div>
          <div style="font-size: 16px; color: #3b82f6; font-weight: 700;">${topCuisine ? topCuisine[0] : 'N/A'}</div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">${topCuisine ? topCuisine[1] + ' locations' : ''}</div>
        </div>

        ${topCuisines.length > 1 ? `
          <div style="background: #0f172a; border: 1px solid #2a3041; border-radius: 8px; padding: 12px; margin-top: 12px;">
            <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 700;">Top 5 Cuisines</div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
              ${topCuisines.map((c, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: ${i < topCuisines.length - 1 ? '1px solid #2a3041' : 'none'};">
                  <span style="font-size: 12px; color: #cbd5e1;">${i + 1}. ${c[0]}</span>
                  <span style="font-size: 12px; font-weight: 600; color: #3b82f6;">${c[1]}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        ${boroughs.length > 1 ? `
          <div style="background: #0f172a; border: 1px solid #2a3041; border-radius: 8px; padding: 12px; margin-top: 12px;">
            <div style="font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 700;">By Borough</div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
              ${boroughs.map((b, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: ${i < boroughs.length - 1 ? '1px solid #2a3041' : 'none'};">
                  <span style="font-size: 12px; color: #cbd5e1;">${b[0]}</span>
                  <span style="font-size: 12px; font-weight: 600; color: #3b82f6;">${b[1]} (${((b[1]/total)*100).toFixed(0)}%)</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
            </div>
            <span style="font-size: 12px; font-weight: 700; color: ${nonGradeAPercent > 50 ? '#ef4444' : '#f59e0b'};">${nonGradeAPercent}%</span>
          </div>
          <span style="font-size: 11px; color: #fda29b;">${gradeB + gradeC} restaurants not Grade A</span>
        </div>

          <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
            ${uniqueCuisines > 1 ? `<div>‚Ä¢ <strong>${uniqueCuisines} different cuisines</strong> available (diversity: ${diversityScore})</div>` : ''}
            ${topBorough ? `<div>‚Ä¢ <strong>${topBorough[0]}</strong> has the most restaurants (${topBoroughPercent}%)</div>` : ''}
            ${parseFloat(gradeAPercent) > 70 ? `<div style="color: #86efac;">‚úì <strong>Excellent health standards</strong> - ${gradeAPercent}% Grade A</div>` : parseFloat(gradeAPercent) > 50 ? `<div style="color: #fbbf24;">‚ö† <strong>Mixed health standards</strong> - ${gradeAPercent}% Grade A</div>` : `<div style="color: #fca5a5;">‚úó <strong>Low health grades</strong> - Only ${gradeAPercent}% Grade A</div>`}
            ${topCuisine ? `<div>‚Ä¢ <strong>${topCuisine[0]}</strong> is the most common cuisine (${topCuisine[1]} locations)</div>` : ''}
          </div>
        </div>
      `;

      document.getElementById('analyticsBody').innerHTML = html;
    }

    let currentInsightIndex = 0;
    let allInsights = [];
    let insightsAutoRotateInterval = null;

    function generateInsights() {
      const insights = [];

      // 1. Most diverse borough
      const boroughCuisines = {};
      allRestaurants.forEach(r => {
        if (!boroughCuisines[r.boro]) boroughCuisines[r.boro] = new Set();
        boroughCuisines[r.boro].add(r.cuisine_description);
      });
      const mostDiverse = Object.entries(boroughCuisines)
        .sort((a, b) => b[1].size - a[1].size)[0];
      if (mostDiverse) {
        insights.push({
          text: `üçΩÔ∏è ${mostDiverse[0]} has ${mostDiverse[1].size} different cuisines - the most diverse borough in the city`,
          metric: `Unique cuisines: ${mostDiverse[1].size}`
        });
      }

      // 2. Grade A percentage by borough
      const gradesByBorough = {};
      allRestaurants.forEach(r => {
        if (!gradesByBorough[r.boro]) gradesByBorough[r.boro] = { a: 0, total: 0 };
        gradesByBorough[r.boro].total++;
        if (r.grade === 'A') gradesByBorough[r.boro].a++;
      });
      const healthiestBorough = Object.entries(gradesByBorough)
        .map(([name, data]) => ({ name, percent: (data.a / data.total * 100).toFixed(1) }))
        .sort((a, b) => b.percent - a.percent)[0];
      if (healthiestBorough) {
        insights.push({
          text: `‚ú® ${healthiestBorough.name} restaurants are crushing it - ${healthiestBorough.percent}% have Grade A inspections`,
          metric: `Grade A rate: ${healthiestBorough.percent}%`
        });
      }

      // 3. Most common cuisine
      const cuisineCount = {};
      allRestaurants.forEach(r => {
        cuisineCount[r.cuisine_description] = (cuisineCount[r.cuisine_description] || 0) + 1;
      });
      const topCuisine = Object.entries(cuisineCount)
        .sort((a, b) => b[1] - a[1])[0];
      if (topCuisine) {
        insights.push({
          text: `üçï ${topCuisine[0]} dominates - there are ${topCuisine[1]} ${topCuisine[0]} restaurants in NYC`,
          metric: `Total ${topCuisine[0]}: ${topCuisine[1]}`
        });
      }

      // 4. Rarest cuisine
      const rareCuisines = Object.entries(cuisineCount)
        .sort((a, b) => a[1] - b[1])
        .slice(0, 5);
      if (rareCuisines.length > 0) {
        const rarest = rareCuisines[0];
        insights.push({
          text: `üåü Hunting for something exotic? There's only 1 ${rarest[0]} restaurant in NYC - real gems!`,
          metric: `Rarest cuisines: Only 1-2 each`
        });
      }

      // 5. Restaurant count by borough
      const boroCount = {};
      allRestaurants.forEach(r => {
        boroCount[r.boro] = (boroCount[r.boro] || 0) + 1;
      });
      const mostRestaurants = Object.entries(boroCount)
        .sort((a, b) => b[1] - a[1])[0];
      if (mostRestaurants) {
        insights.push({
          text: `üèôÔ∏è ${mostRestaurants[0]} is a food mecca with ${mostRestaurants[1]} inspected restaurants`,
          metric: `${mostRestaurants[0]} total: ${mostRestaurants[1]} restaurants`
        });
      }

      // 6. Grade C prevalence
      const gradeC = allRestaurants.filter(r => r.grade === 'C').length;
      const gradeCPercent = (gradeC / allRestaurants.length * 100).toFixed(1);
      insights.push({
        text: `‚ö†Ô∏è Only ${gradeCPercent}% of NYC restaurants have Grade C - most places are doing well`,
        metric: `Grade C restaurants: ${gradeC}`
      });

      // 7. Average restaurants per zipcode
      const zipCount = {};
      allRestaurants.forEach(r => {
        if (r.zipcode) zipCount[r.zipcode] = (zipCount[r.zipcode] || 0) + 1;
      });
      const avgZipRestaurants = (Object.values(zipCount).reduce((a, b) => a + b, 0) / Object.keys(zipCount).length).toFixed(1);
      insights.push({
        text: `üìç On average, each NYC zip code has ${avgZipRestaurants} inspected restaurants`,
        metric: `Average restaurants per zip: ${avgZipRestaurants}`
      });

      // 8. Top 5 cuisines
      const top5Cuisines = Object.entries(cuisineCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, count]) => `${name} (${count})`);
      insights.push({
        text: `üç¥ The top 5 cuisines in NYC: ${top5Cuisines.join(', ')}`,
        metric: `Top cuisines dominate the market`
      });

      // 9. Chinese restaurants
      const chineseCount = allRestaurants.filter(r => r.cuisine_description.toLowerCase().includes('chinese')).length;
      insights.push({
        text: `ü•¢ There are ${chineseCount} Chinese restaurants in NYC - explore their distribution across neighborhoods`,
        metric: `Chinese restaurants: ${chineseCount}`
      });

      // 10. Italian restaurants
      const italianCount = allRestaurants.filter(r => r.cuisine_description.toLowerCase().includes('italian')).length;
      insights.push({
        text: `üçù Italian cuisine has ${italianCount} locations - the second most represented food culture`,
        metric: `Italian restaurants: ${italianCount}`
      });

      // 11. Pizza places
      const pizzaCount = allRestaurants.filter(r => r.cuisine_description.toLowerCase().includes('pizza')).length;
      insights.push({
        text: `üçï NYC has ${pizzaCount} pizza shops - enough for every New Yorker to have a favorite`,
        metric: `Pizza places: ${pizzaCount}`
      });

      // 12. Seafood restaurants
      const seafoodCount = allRestaurants.filter(r => r.cuisine_description.toLowerCase().includes('seafood')).length;
      insights.push({
        text: `ü¶û Seafood enthusiasts rejoice - there are ${seafoodCount} seafood restaurants to explore`,
        metric: `Seafood restaurants: ${seafoodCount}`
      });

      // 13. Vegetarian options
      const vegetarianCount = allRestaurants.filter(r => r.cuisine_description.toLowerCase().includes('vegetarian')).length;
      insights.push({
        text: `ü•¨ NYC is surprisingly vegan-friendly with ${vegetarianCount} vegetarian/vegan restaurants`,
        metric: `Vegetarian restaurants: ${vegetarianCount}`
      });

      // 14. Borough with most cuisines per restaurant
      const cuisinesDensity = Object.entries(boroughCuisines)
        .map(([name, cuisines]) => ({
          name,
          ratio: (cuisines.size / boroCount[name]).toFixed(2),
          total: boroCount[name]
        }))
        .sort((a, b) => b.ratio - a.ratio)[0];
      if (cuisinesDensity) {
        insights.push({
          text: `üåç ${cuisinesDensity.name} has the most diverse food scene per capita - ${cuisinesDensity.ratio} cuisines per 10 restaurants`,
          metric: `Cuisine density: ${cuisinesDensity.ratio} per 10 restaurants`
        });
      }

      return insights;
    }

    function displayInsight(index) {
      if (allInsights.length === 0) return;
      currentInsightIndex = (index + allInsights.length) % allInsights.length;
      const insight = allInsights[currentInsightIndex];

      document.getElementById('insightText').textContent = insight.text;
      document.getElementById('insightCounter').textContent = `${currentInsightIndex + 1} of ${allInsights.length}`;

      // Update dots
      document.querySelectorAll('.dot').forEach((dot, idx) => {
        dot.classList.toggle('active', idx === currentInsightIndex);
      });
    }

    function initInsightsCarousel() {
      allInsights = generateInsights();
      if (allInsights.length === 0) return;

      const carousel = document.getElementById('insightsCarousel');
      const dotsContainer = document.getElementById('carouselDots');

      // Create dots
      allInsights.forEach((_, idx) => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        if (idx === 0) dot.classList.add('active');
        dot.addEventListener('click', () => {
          clearInterval(insightsAutoRotateInterval);
          displayInsight(idx);
          startAutoRotate();
        });
        dotsContainer.appendChild(dot);
      });

      // Set up arrow buttons
      document.getElementById('prevInsight').addEventListener('click', () => {
        clearInterval(insightsAutoRotateInterval);
        displayInsight(currentInsightIndex - 1);
        startAutoRotate();
      });
      document.getElementById('nextInsight').addEventListener('click', () => {
        clearInterval(insightsAutoRotateInterval);
        displayInsight(currentInsightIndex + 1);
        startAutoRotate();
      });

      carousel.classList.remove('hidden');
      displayInsight(0);
      startAutoRotate();
    }

    function startAutoRotate() {
      clearInterval(insightsAutoRotateInterval);
      insightsAutoRotateInterval = setInterval(() => {
        displayInsight(currentInsightIndex + 1);
      }, 5000); // Rotate every 5 seconds
    }

    // Onboarding Flow
    let currentOnboardingStep = 0;
    const onboardingSteps = [
      {
        icon: 'üóΩ',
        title: 'Welcome to Dine Scout',
        subtitle: 'Explore NYC\'s <span class="onboarding-highlight">food ecosystem</span> - discover patterns, trends, and hidden gems across the five boroughs. Data sourced from <span class="onboarding-highlight">NYC Department of Health restaurant inspections</span>.',
        features: [
          { icon: 'üåç', text: 'Explore how cuisines cluster and evolve' },
          { icon: 'üìä', text: 'See health grades & safety records' },
          { icon: 'üîç', text: 'Uncover neighborhoods\' food cultures' },
          { icon: 'üìà', text: 'Track food diversity by district' }
        ]
      },
      {
        icon: 'üåø',
        title: 'Food Ecosystems in Motion',
        subtitle: 'Like natural ecosystems, NYC\'s food scene thrives on <span class="onboarding-highlight">relationships and cycles</span>. Cuisines influence each other, neighborhoods evolve, and food shapes culture.',
        features: [
          { icon: 'üçΩÔ∏è', text: 'Different cuisines coexist & influence' },
          { icon: 'üèôÔ∏è', text: 'Each neighborhood has unique patterns' },
          { icon: '‚ö°', text: 'Health & safety create natural cycles' },
          { icon: 'üåê', text: 'Immigration & culture drive diversity' }
        ]
      },
      {
        icon: 'üîç',
        title: 'How to Explore',
        subtitle: 'Use filters to narrow down by <span class="onboarding-highlight">neighborhood, cuisine, grade</span>, or borough. Watch insights appear in real-time. Dataset: ~11,000 NYC restaurants with valid health grades (A/B/C).',
        features: [
          { icon: 'üìç', text: 'Search by neighborhood or ZIP' },
          { icon: 'üçú', text: 'Filter by cuisine type' },
          { icon: '‚≠ê', text: 'Sort by health grade (A/B/C)' },
          { icon: 'üìã', text: 'Toggle map & list views' }
        ]
      },
      {
        icon: '‚ú®',
        title: 'Automatic Insights',
        subtitle: 'Every search unlocks <span class="onboarding-highlight">new data stories</span>. See statistics, charts, and patterns emerge as you explore different areas.',
        features: [
          { icon: 'üìä', text: 'Real-time analytics sidebar' },
          { icon: 'üí°', text: 'Rotating data insights' },
          { icon: 'üìà', text: 'Cuisine & grade breakdowns' },
          { icon: 'üéØ', text: 'Discover neighborhoods\' strengths' }
        ]
      },
      {
        icon: 'üöÄ',
        title: 'Ready to Explore?',
        subtitle: 'Start with a neighborhood you love, a cuisine you\'re curious about, or dive in randomly. Every click reveals something new about how NYC eats.',
        features: [
          { icon: 'üé≤', text: 'Use Random button for discovery' },
          { icon: 'üó∫Ô∏è', text: 'Pan & zoom to explore visually' },
          { icon: 'üí¨', text: 'Click markers for details' },
          { icon: 'üîÑ', text: 'Combine multiple filters' }
        ]
      }
    ];

    function renderOnboardingStep(stepIndex) {
      try {
        const step = onboardingSteps[stepIndex];
        if (!step) {
          console.error('Step not found:', stepIndex);
          return;
        }

        const content = document.getElementById('onboardingContent');
        if (!content) {
          console.error('onboardingContent element not found');
          return;
        }

        let featuresHTML = '';
        if (step.features && step.features.length > 0) {
          featuresHTML = `
            <div class="onboarding-features">
              ${step.features.map(f => `
                <div class="onboarding-feature">
                  <div class="onboarding-feature-icon">${f.icon}</div>
                  <div>${f.text}</div>
                </div>
              `).join('')}
            </div>
          `;
        }

        content.innerHTML = `
          <div class="onboarding-icon">${step.icon}</div>
          <h2 class="onboarding-title">${step.title}</h2>
          <p class="onboarding-subtitle">${step.subtitle}</p>
          ${featuresHTML}
        `;

        console.log('Rendered step:', stepIndex, step.title);

        // Update dots
        document.querySelectorAll('.onboarding-dot').forEach((dot, idx) => {
          dot.classList.toggle('active', idx === stepIndex);
        });

        // Update progress
        const progressText = document.getElementById('progressText');
        if (progressText) progressText.textContent = stepIndex + 1;

        // Update button text
        const nextBtn = document.getElementById('onboardingNext');
        if (nextBtn) {
          if (stepIndex === onboardingSteps.length - 1) {
            nextBtn.textContent = 'Start Exploring';
          } else {
            nextBtn.textContent = 'Next';
          }
        }
      } catch (e) {
        console.error('Error rendering onboarding step:', e);
      }
    }

    function playUtensilDrop() {
      const fork = document.getElementById('forkDrop');
      const knife = document.getElementById('knifeDrop');

      if (!fork || !knife) return;

      // Show the utensils
      fork.style.display = 'block';
      knife.style.display = 'block';
    }

    function initOnboarding() {
      const overlay = document.getElementById('onboardingOverlay');
      if (!overlay) {
        console.error('Onboarding overlay not found');
        return;
      }

      // Check if user already saw onboarding
      if (localStorage.getItem('dinescoutOnboardingComplete')) {
        overlay.classList.add('hidden');
        return;
      }

      // Make sure overlay is visible
      overlay.classList.remove('hidden');

      // Play utensil drop animation
      playUtensilDrop();

      const dotsNav = document.getElementById('dotsNav');
      const nextBtn = document.getElementById('onboardingNext');
      const skipBtn = document.getElementById('onboardingSkip');

      if (!dotsNav || !nextBtn || !skipBtn) {
        console.error('Onboarding elements not found');
        return;
      }

      // Create navigation dots
      onboardingSteps.forEach((_, idx) => {
        const dot = document.createElement('div');
        dot.className = 'onboarding-dot';
        if (idx === 0) dot.classList.add('active');
        dot.addEventListener('click', () => {
          currentOnboardingStep = idx;
          renderOnboardingStep(idx);
        });
        dotsNav.appendChild(dot);
      });

      // Event listeners
      nextBtn.addEventListener('click', () => {
        if (currentOnboardingStep === onboardingSteps.length - 1) {
          closeOnboarding();
        } else {
          currentOnboardingStep++;
          renderOnboardingStep(currentOnboardingStep);
        }
      });

      skipBtn.addEventListener('click', () => closeOnboarding(true));

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!overlay.classList.contains('hidden')) {
          if (e.key === 'ArrowRight') {
            nextBtn.click();
          } else if (e.key === 'Escape') {
            closeOnboarding();
          }
        }
      });

      // Render first step
      console.log('Rendering onboarding step 0');
      renderOnboardingStep(0);
      console.log('Onboarding initialized');
    }

    function closeOnboarding(skipEarly = false) {
      document.getElementById('onboardingOverlay').classList.add('hidden');
      // Only mark complete if user finished all screens (not if they skip early)
      if (!skipEarly) {
        localStorage.setItem('dinescoutOnboardingComplete', 'true');
      }
    }

    // Utility function to reset onboarding for testing
    window.resetOnboarding = function() {
      localStorage.removeItem('dinescoutOnboardingComplete');
      document.getElementById('onboardingOverlay').classList.remove('hidden');
      currentOnboardingStep = 0;
      document.getElementById('dotsNav').innerHTML = '';
      initOnboarding();
      console.log('Onboarding reset - should now show');
    };

    async function init() {
      initMap();
      buildBoroughCheckboxes();
      buildNeighborhoodDatalist();
      const loaded = await fetchData();
      if (loaded) {
        buildCuisineCheckboxes(); // Build after data is loaded
        filteredRestaurants = [...allRestaurants];
        updateMap();
        updateResultsCount();
        initInsightsCarousel(); // Initialize carousel with insights

        document.getElementById('search').addEventListener('input', debounce(() => {
          applyFilters();
          updateAnalytics();
        }, 300));
        document.getElementById('locationSearch').addEventListener('input', debounce(() => {
          applyFilters();
          updateAnalytics();
        }, 300));

        // event delegation for dynamically created cuisine checkboxes
        document.getElementById('cuisineCheckboxes').addEventListener('change', (e) => {
          if (e.target.classList.contains('cuisine-checkbox')) {
            applyFilters();
            updateAnalytics();
          }
        });

        // Cuisine search filter
        document.getElementById('cuisineSearch').addEventListener('input', (e) => {
          filterCuisines(e.target.value);
          applyFilters();
          updateAnalytics();
        });

        document.querySelectorAll('.grade-checkbox').forEach(cb => cb.addEventListener('change', () => {
          applyFilters();
          updateAnalytics();
        }));
        document.querySelectorAll('.borough-checkbox').forEach(cb => cb.addEventListener('change', () => {
          applyFilters();
          updateAnalytics();
        }));

        // Filter panel controls
        document.getElementById('filterToggle').addEventListener('click', toggleFilterPanel);
        document.getElementById('filterClose').addEventListener('click', toggleFilterPanel);

        // Analytics controls
        document.getElementById('analyticsToggleBtn').addEventListener('click', toggleAnalyticsPanel);
        document.getElementById('analyticsCloseBtn').addEventListener('click', toggleAnalyticsPanel);

        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        document.getElementById('randomBtn').addEventListener('click', chooseRandom);
        document.getElementById('heatmapToggle').addEventListener('click', toggleHeatmap);
        document.getElementById('markersToggle').addEventListener('click', toggleHeatmap);
        document.getElementById('clusteringToggle').addEventListener('click', toggleClustering);
        document.getElementById('listViewToggle').addEventListener('click', toggleListView);
        document.getElementById('closePanel').addEventListener('click', closeSelectedPanel);
        document.getElementById('prevBtn').addEventListener('click', () => navigateRestaurants('prev'));
        document.getElementById('nextBtn').addEventListener('click', () => navigateRestaurants('next'));

        // Note: webToggle listener is attached outside this block

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (selectedRestaurant && !e.target.matches('input, textarea')) {
            if (e.key === 'ArrowLeft') navigateRestaurants('prev');
            if (e.key === 'ArrowRight') navigateRestaurants('next');
            if (e.key === 'Escape') closeSelectedPanel();
          }
        });
      }

      // Attach web toggle listener outside of loaded check to ensure it's always available
      const webToggleBtn = document.getElementById('webToggle');
      if (webToggleBtn) {
        webToggleBtn.addEventListener('click', toggleWebMode);
      }

      document.getElementById('loading').classList.add('hidden');

      // Initialize onboarding with small delay to ensure DOM is ready
      setTimeout(() => {
        initOnboarding();
      }, 100);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  
</body>
</html>
