<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dine Scout</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; position: relative; }
    .map-container { position: relative; background: #0f172a; flex: 1; }
    #map { width: 100%; height: 100%; }

    /* Floating title */
    .app-title {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1002;
      color: #f1f5f9;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    /* Floating filter panel (Google Maps style) */
    .filter-panel {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 360px;
      background: #1a2332;
      border: 1px solid #2a3041;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 0;
      max-height: 73vh;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-panel.collapsed { width: 48px; }
    .filter-panel.collapsed .filter-content { display: none; }
    .filter-panel.collapsed .filter-toggle { border-radius: 12px; }

    .filter-toggle {
      padding: 14px;
      background: transparent;
      border: none;
      color: #cbd5e1;
      font-size: 16px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 12px 0 0 12px;
      transition: all 0.2s;
    }

    .filter-toggle:hover {
      background: #2a3041;
      color: #f1f5f9;
    }

    .filter-panel.collapsed .filter-toggle { display: flex; }

    .filter-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .filter-content::-webkit-scrollbar { width: 6px; }
    .filter-content::-webkit-scrollbar-track { background: transparent; }
    .filter-content::-webkit-scrollbar-thumb { background: #2a3041; border-radius: 3px; }
    .filter-content::-webkit-scrollbar-thumb:hover { background: #3a4051; }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2a3041;
    }

    .filter-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .filter-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .filter-close:hover {
      color: #f1f5f9;
    }

    .filter-section {
      margin-bottom: 14px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-section h3 {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      color: #94a3b8;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .search-box, .dropdown {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #2a3041;
      border-radius: 8px;
      font-size: 13px;
      background: #0f172a;
      color: #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .search-box::placeholder { color: #64748b; }
    .search-box:focus, .dropdown:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), inset 0 0 0 1px rgba(59, 130, 246, 0.2);
      background: #1a2332;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 5px 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .checkbox-item:hover {
      background: #2a3041;
      opacity: 1;
    }
    .checkbox-item input {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #3b82f6;
      flex-shrink: 0;
    }
    .checkbox-item label {
      cursor: pointer;
      font-size: 13px;
      color: #cbd5e1;
    }

    .checkbox-group.max-height {
      max-height: 140px;
      overflow-y: auto;
    }
    .checkbox-group.max-height::-webkit-scrollbar { width: 6px; }
    .checkbox-group.max-height::-webkit-scrollbar-track { background: transparent; border-radius: 3px; }
    .checkbox-group.max-height::-webkit-scrollbar-thumb { background: #2a3041; border-radius: 3px; }
    .checkbox-group.max-height::-webkit-scrollbar-thumb:hover { background: #3a4051; }

    .results-count {
      padding: 12px;
      background: #0f172a;
      border: 1px solid #2a3041;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #60a5fa;
    }

    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      width: 100%;
      letter-spacing: 0.3px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:active { transform: translateY(0); }

    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-random {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    .btn-random:hover {
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-secondary {
      background: #2a3041;
      color: #e2e8f0;
      border: 1px solid #3b82f6;
    }
    .btn-secondary:hover {
      background: #3a4051;
      border-color: #60a5fa;
    }

    /* Analytics Sidebar */
    .analytics-sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 360px;
      height: 100%;
      background: #1a2332;
      border-left: 1px solid #2a3041;
      box-shadow: -8px 0 32px rgba(0,0,0,0.4);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .analytics-sidebar.visible {
      transform: translateX(0);
    }

    .analytics-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #2a3041;
      flex-shrink: 0;
    }

    .analytics-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
      margin: 0;
    }

    .analytics-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      transition: all 0.2s;
    }

    .analytics-close:hover {
      color: #f1f5f9;
    }

    .analytics-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .analytics-content::-webkit-scrollbar {
      width: 6px;
    }

    .analytics-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .analytics-content::-webkit-scrollbar-thumb {
      background: #2a3041;
      border-radius: 3px;
    }

    .analytics-content::-webkit-scrollbar-thumb:hover {
      background: #3a4051;
    }

    .analytics-toggle {
      position: fixed;
      bottom: 40px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #1a2332;
      border: 2px solid #2a3041;
      color: #cbd5e1;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 800;
      padding: 0;
    }

    .analytics-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      border-color: #3b82f6;
    }

    .analytics-toggle.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    }

    .stat-card {
      background: #0f172a;
      border: 1px solid #2a3041;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .stat-card h4 {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: #94a3b8;
      letter-spacing: 0.5px;
      margin: 0 0 8px 0;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #3b82f6;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }

    .chart-container {
      background: #0f172a;
      border: 1px solid #2a3041;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .chart-container h4 {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: #94a3b8;
      letter-spacing: 0.5px;
      margin: 0 0 12px 0;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bar-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bar-label {
      font-size: 11px;
      color: #cbd5e1;
      min-width: 80px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .bar {
      flex: 1;
      height: 20px;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }

    .bar-value {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      font-weight: 600;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .toggle-buttons {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      gap: 8px;
      z-index: 1001;
      pointer-events: none;
    }
    .toggle-buttons .toggle-btn {
      pointer-events: auto;
    }

    .toggle-btn {
      padding: 8px 12px;
      background: #1a2332;
      border: 1px solid #2a3041;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: #cbd5e1;
      white-space: nowrap;
    }
    .toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border-color: #3b82f6;
    }
    .toggle-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a2332;
      padding: 48px;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      text-align: center;
      z-index: 9999;
      border: 1px solid #2a3041;
    }
    .loading p { color: #cbd5e1; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #2a3041;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-message {
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #7f1d1d;
      border: 1px solid #b91c1c;
      color: #fecaca;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 9998;
      max-width: 500px;
    }
    .hidden { display: none !important; }

    .popup-name { font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #f1f5f9; }
    .popup-info { margin: 6px 0; color: #cbd5e1; font-size: 13px; }
    .popup-grade { display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: 700; font-size: 11px; margin-top: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .grade-a { background: #10b981; color: white; }
    .grade-b { background: #f59e0b; color: white; }
    .grade-c { background: #ef4444; color: white; }
    .popup-link { display: inline-block; margin-top: 12px; padding: 8px 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 600; transition: all 0.2s; }
    .popup-link:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

    /* Leaflet popup dark theme */
    .leaflet-popup-content-wrapper { background: #1a2332 !important; color: #e2e8f0 !important; border: 1px solid #2a3041 !important; border-radius: 8px !important; }
    .leaflet-popup-content { color: #e2e8f0 !important; margin: 16px !important; }
    .leaflet-popup-tip { background: #1a2332 !important; border: 1px solid #2a3041 !important; }

    /* Selected restaurant panel */
    .selected-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(26, 35, 50, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
      backdrop-filter: blur(10px);
      border-top: 1px solid #2a3041;
      padding: 24px;
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 50vh;
      overflow-y: auto;
    }
    .selected-panel.visible { transform: translateY(0); }
    .selected-panel h2 { font-size: 24px; margin-bottom: 12px; color: #f1f5f9; }
    .selected-panel .selected-info { display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start; }
    .selected-panel .selected-details { display: flex; flex-direction: column; gap: 8px; }
    .selected-panel .selected-actions { display: flex; flex-direction: column; gap: 12px; }
    .selected-panel .detail-item { color: #cbd5e1; font-size: 14px; }
    .selected-panel .detail-item strong { color: #94a3b8; }
    .selected-panel .close-btn { position: absolute; top: 16px; right: 16px; background: transparent; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
    .selected-panel .close-btn:hover { background: #2a3041; color: #f1f5f9; }

    /* Restaurant list view */
    .restaurant-list {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      border-top: 1px solid #2a3041;
      max-height: 40vh;
      overflow-y: auto;
      z-index: 999;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      padding: 20px;
    }
    .restaurant-list.visible { transform: translateY(0); }
    .restaurant-card { background: #1a2332; border: 1px solid #2a3041; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s; }
    .restaurant-card:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
    .restaurant-card.selected { border-color: #3b82f6; background: linear-gradient(135deg, #1a2332 0%, #1e3a5f 100%); box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4); }
    .restaurant-card h3 { font-size: 16px; margin-bottom: 8px; color: #f1f5f9; }
    .restaurant-card .card-info { font-size: 12px; color: #94a3b8; margin: 4px 0; }

    /* Navigation controls */
    .nav-controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 501; }
    .nav-btn { padding: 12px 20px; background: #1a2332; border: 1px solid #2a3041; border-radius: 8px; color: #cbd5e1; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .nav-btn:hover:not(:disabled) { background: #2a3041; border-color: #3b82f6; color: #f1f5f9; transform: translateY(-2px); }
    .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .leaflet-top, .leaflet-bottom {
      z-index: 400;
    }

  </style>

  <!-- Neighborhood typeahead list -->
  <datalist id="neighborhoodsList"></datalist>
</head>
<body>
  <div class="container">
    <div class="map-container">
      <div id="map"></div>

      <!-- Floating title -->
      <div class="app-title">Dine Scout</div>

      <!-- Floating filter panel -->
      <div class="filter-panel" id="filterPanel">
        <button class="filter-toggle" id="filterToggle" title="Toggle filters">‚öôÔ∏è</button>
        <div class="filter-content">
          <div class="filter-header">
            <h2>Filters</h2>
            <button class="filter-close" id="filterClose">‚úï</button>
          </div>

          <div class="filter-section">
            <div class="results-count"><div id="resultsCount">Loading...</div></div>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" id="clearFiltersBtn">Clear All</button>
            <button class="btn btn-primary btn-random" id="randomBtn">üé≤ Random</button>
          </div>

          <div class="filter-section">
            <h3>Restaurant</h3>
            <input type="text" id="search" class="search-box" placeholder="Search by name...">
          </div>

          <div class="filter-section">
            <h3>Location</h3>
            <input type="text" id="locationSearch" class="search-box" list="neighborhoodsList" placeholder="Neighborhood or Zip...">
          </div>

          <div class="filter-section">
            <h3>Cuisine</h3>
            <input type="text" id="cuisineSearch" class="search-box" placeholder="Search cuisine...">
            <div class="checkbox-group max-height" id="cuisineCheckboxes"></div>
          </div>

          <div class="filter-section">
            <h3>Grade</h3>
            <div class="checkbox-group">
              <div class="checkbox-item"><input type="checkbox" id="gradeA" value="A" class="grade-checkbox"><label for="gradeA">A - Excellent</label></div>
              <div class="checkbox-item"><input type="checkbox" id="gradeB" value="B" class="grade-checkbox"><label for="gradeB">B - Good</label></div>
              <div class="checkbox-item"><input type="checkbox" id="gradeC" value="C" class="grade-checkbox"><label for="gradeC">C - Satisfactory</label></div>
            </div>
          </div>

          <div class="filter-section">
            <h3>Borough</h3>
            <div class="checkbox-group" id="boroughCheckboxes"></div>
          </div>
        </div>
      </div>

      <!-- Map controls (top center) -->
      <div class="toggle-buttons">
        <button class="toggle-btn active" id="markersToggle" title="Show markers">üìç Markers</button>
        <button class="toggle-btn" id="heatmapToggle" title="Show heatmap">üî• Heatmap</button>
        <button class="toggle-btn active" id="clusteringToggle" title="Toggle clustering">üéØ Cluster</button>
        <button class="toggle-btn" id="listViewToggle" title="Show list view">üìã List</button>
      </div>

      <!-- Navigation controls -->
      <div class="nav-controls hidden" id="navControls">
        <button class="nav-btn" id="prevBtn">‚Üê Previous</button>
        <button class="nav-btn" id="nextBtn">Next ‚Üí</button>
      </div>

      <!-- Selected restaurant panel (bottom) -->
      <div class="selected-panel" id="selectedPanel">
        <button class="close-btn" id="closePanel">√ó</button>
        <div id="selectedContent"></div>
      </div>

      <!-- Restaurant list view (bottom) -->
      <div class="restaurant-list" id="restaurantList"></div>

      <!-- Analytics sidebar (right) -->
      <div class="analytics-sidebar" id="analyticsSidebar">
        <div class="analytics-header">
          <h3>Analytics</h3>
          <button class="analytics-close" id="analyticsClose">√ó</button>
        </div>
        <div class="analytics-content" id="analyticsContent">
          <div style="padding: 20px; text-align: center; color: #94a3b8;">
            Search for a neighborhood, zipcode, or cuisine to see analytics
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics toggle button (outside map) -->
  <button class="analytics-toggle" id="analyticsToggle" title="Show Analytics">üìä</button>
  <div id="loading" class="loading"><div class="spinner"></div><p>Loading restaurants...</p></div>
  <div id="errorMessage" class="error-message hidden"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script>
    let allRestaurants = [], filteredRestaurants = [], map, markersLayer, clusterGroup, heatmapLayer;
    let isHeatmapMode = false, isClusteringEnabled = true, isListViewVisible = false;
    let selectedRestaurant = null, selectedIndex = -1;
    let restaurantMarkers = new Map(); // Store markers for quick lookup
    const boroughs = ['Manhattan', 'Bronx', 'Brooklyn', 'Queens', 'Staten Island'];
    const gradeColors = { 'A': '#10b981', 'B': '#f59e0b', 'C': '#ef4444' };

    // --- Neighborhood <-> ZIP crosswalk (starter; extend as needed) ---
    const NEIGHBORHOOD_ZIPS = {
      // MANHATTAN
      "upper west side": ["10023","10024","10025"],
      "upper east side": ["10021","10028","10065","10075","10128"],
      "harlem": ["10026","10027","10030","10037","10039"],
      "east harlem": ["10029","10035"],
      "washington heights": ["10032","10033","10040"],
      "inwood": ["10034"],
      "chelsea": ["10001","10011"],
      "hells kitchen": ["10019","10036"],
      "midtown": ["10017","10018","10019","10020","10022"],
      "murray hill": ["10016"],
      "kips bay": ["10016"],
      "gramercy": ["10010"],
      "flatiron": ["10010","10011"],
      "greenwich village": ["10012","10014"],
      "west village": ["10014"],
      "east village": ["10003","10009"],
      "soho": ["10012"],
      "noho": ["10003","10012"],
      "nolita": ["10012"],
      "tribeca": ["10007","10013"],
      "chinatown": ["10002","10013"],
      "lower east side": ["10002"],
      "financial district": ["10004","10005","10006","10007","10038","10280","10282"],
      "battery park city": ["10280","10282"],
      "two bridges": ["10002"],

      // BROOKLYN
      "williamsburg": ["11211","11249"],
      "greenpoint": ["11222"],
      "bushwick": ["11207","11221","11237"],
      "bedford-stuyvesant": ["11205","11206","11216","11221","11233"],
      "clinton hill": ["11205"],
      "fort greene": ["11205","11217"],
      "downtown brooklyn": ["11201","11217"],
      "brooklyn heights": ["11201"],
      "dumbo": ["11201"],
      "boerum hill": ["11217"],
      "cobble hill": ["11201","11231"],
      "carroll gardens": ["11231"],
      "gowanus": ["11217","11231"],
      "park slope": ["11215"],
      "prospect heights": ["11238","11217"],
      "crown heights": ["11213","11216","11225","11233"],
      "prospect lefferts gardens": ["11225"],
      "flatbush": ["11226"],
      "kensington": ["11218"],
      "sunset park": ["11220","11232"],
      "bay ridge": ["11209"],
      "red hook": ["11231"],
      "sheepshead bay": ["11235"],
      "brighton beach": ["11235"],
      "canarsie": ["11236"],
      "brownsville": ["11212","11233"],

      // QUEENS
      "astoria": ["11102","11103","11105","11106"],
      "long island city": ["11101","11109"],
      "sunnyside": ["11104"],
      "woodside": ["11377"],
      "jackson heights": ["11372","11373"],
      "elmhurst": ["11373"],
      "flushing": ["11354","11355","11358"],
      "forest hills": ["11375"],
      "rego park": ["11374"],
      "jamaica": ["11432","11433","11435"],
      "ridgewood": ["11385"],
      "corona": ["11368"],
      "bayside": ["11360","11361","11364"],
      "rockaways": ["11691","11692","11693","11694","11697"],

      // BRONX
      "riverdale": ["10463","10471"],
      "kingsbridge": ["10463","10468"],
      "fordham": ["10458","10468"],
      "mott haven": ["10454","10455"],
      "melrose": ["10451","10455"],
      "south bronx": ["10451","10454","10455","10459"],
      "pelham bay": ["10461"],
      "throgs neck": ["10465"],
      "parkchester": ["10462"],
      "soundview": ["10472","10473"],
      "city island": ["10464"],

      // STATEN ISLAND
      "st. george": ["10301"],
      "stapleton": ["10304"],
      "tottenville": ["10307"],
      "great kills": ["10308"],
      "new dorp": ["10306"],
      "port richmond": ["10302"],
      "west brighton": ["10310"],
      "arden heights": ["10312"]
    };

    // Common shorthand / alt spellings
    const NEIGHBORHOOD_SYNONYMS = {
      "uws": "upper west side",
      "ues": "upper east side",
      "les": "lower east side",
      "fidi": "financial district",
      "wburg": "williamsburg",
      "lic": "long island city",
      "bed stuy": "bedford-stuyvesant",
      "bed-stuy": "bedford-stuyvesant",
      "bk heights": "brooklyn heights",
      "bpc": "battery park city",
      "ev": "east village",
      "wv": "west village",
      "tribecca": "tribeca"
    };

    const normalize = s => (s || "").toLowerCase().trim();
    const isZip = s => /^\d{5}$/.test(s);

    // Try to resolve a free-text location to a set of ZIPs + a display name
    function resolveLocationToZips(q) {
      const s = normalize(q);
      if (!s) return null;
      if (isZip(s)) return { name: s, zips: [s] };

      const base = NEIGHBORHOOD_SYNONYMS[s] || s;
      if (NEIGHBORHOOD_ZIPS[base]) return { name: titleCase(base), zips: NEIGHBORHOOD_ZIPS[base] };

      // loose partial match (e.g., "heights", "village", "ridge")
      const candidates = Object.keys(NEIGHBORHOOD_ZIPS).filter(k => k.includes(base) || base.includes(k));
      if (candidates.length) {
        const set = new Set();
        candidates.forEach(k => NEIGHBORHOOD_ZIPS[k].forEach(z => set.add(z)));
        const preferred = candidates.sort((a,b)=>a.length-b.length)[0];
        return { name: titleCase(preferred), zips: [...set] };
      }
      return null;
    }

    function titleCase(s) {
      return s.replace(/\b\w/g, c => c.toUpperCase());
    }

    function buildNeighborhoodDatalist() {
      const dl = document.getElementById('neighborhoodsList');
      dl.innerHTML = "";
      const names = Object.keys(NEIGHBORHOOD_ZIPS).sort();
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = titleCase(n);
        dl.appendChild(opt);
      });
    }
  
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }
  
    function showError(msg) {
      const el = document.getElementById('errorMessage');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

  
    // ---- Helpers for dates / history ----
    function parseDateSafe(s) {
      if (!s) return null;
      // NYC API dates like "2024-05-11T00:00:00.000"
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }
  
    function formatDateYYYYMMDD(d) {
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
      // --- NYC bounds, cuisine normalization, sane dates ---
    const NYC_BBOX = { minLat: 40.4774, maxLat: 40.9176, minLon: -74.2591, maxLon: -73.7004 };

    function inNYC(lat, lon) {
      return lat >= NYC_BBOX.minLat && lat <= NYC_BBOX.maxLat && lon >= NYC_BBOX.minLon && lon <= NYC_BBOX.maxLon;
    }

    const CUISINE_ALIAS = new Map([
      ['bakery products/desserts','Bakery'],
      ['caf√â','Cafe'], ['caf√©','Cafe'], ['cafe','Cafe'],
      ['coffee/tea','Coffee/Tea'], ['tea/coffee','Coffee/Tea'],
      ['pizzeria','Pizza'], ['pizza','Pizza'],
      ['bbq','Barbecue'], ['barbeque','Barbecue'], ['barbecue','Barbecue'],
      ['american','American'], ['chinese','Chinese'], ['japanese','Japanese'],
      ['italian','Italian'], ['mexican','Mexican'],
      ['unknown','Unknown']
    ]);

    function normCuisine(s) {
      if (!s) return 'Unknown';
      let t = s.trim().toLowerCase().replace(/\s+/g,' ');
      t = CUISINE_ALIAS.get(t) ?? t.replace(/\b\w/g, c => c.toUpperCase());
      return t;
    }

    // ignore bogus defaults; accept years [2000..next year]
    function saneDate(s) {
      if (!s) return null;
      const d = new Date(s);
      const nowY = new Date().getFullYear();
      if (isNaN(d) || d.getFullYear() < 2000 || d.getFullYear() > nowY + 1) return null;
      return d;
    }
    async function fetchData() {
  try {
    const res = await fetch('https://data.cityofnewyork.us/resource/43nn-pn8j.json?$limit=50000');
    if (!res.ok) throw new Error('Network error');
    const raw = await res.json();

    const nycBoros = new Set(['Manhattan', 'Bronx', 'Brooklyn', 'Queens', 'Staten Island']);

    // basic validity filter
    const valid = raw.filter(r => {
      const lat = parseFloat(r.latitude);
      const lon = parseFloat(r.longitude);
      return r.camis && r.dba && r.boro && nycBoros.has(r.boro)
        && Number.isFinite(lat) && Number.isFinite(lon)
        && lat !== 0 && lon !== 0 && inNYC(lat, lon);
    });
    // group by CAMIS; dedup dates same-day
    const byCamis = new Map();
    for (const r of valid) {
      const camis = r.camis;
      const lat = parseFloat(r.latitude);
      const lon = parseFloat(r.longitude);

      const entry = byCamis.get(camis) ?? {
        camis,
        dba: r.dba || 'Unknown',
        building: r.building || '',
        street: r.street || '',
        boro: r.boro,
        zipcode: r.zipcode || '',
        cuisine_description: normCuisine(r.cuisine_description || 'Unknown'),
        lat, lon,
        dates: new Set(), // yyyy-mm-dd
        latestDate: null,
        grade: r.grade || null // kept if you still color markers by grade; ignore if not used
      };

      // keep freshest valid coords seen
      if (Number.isFinite(lat) && Number.isFinite(lon)) { entry.lat = lat; entry.lon = lon; }

      const dt = saneDate(r.inspection_date);
      if (dt) {
        const day = dt.toISOString().slice(0,10);
        entry.dates.add(day);
        if (!entry.latestDate || dt > entry.latestDate) entry.latestDate = dt;
      }

      // prefer non-empty address parts when missing
      if (!entry.building && r.building) entry.building = r.building;
      if (!entry.street && r.street) entry.street = r.street;
      if (!entry.zipcode && r.zipcode) entry.zipcode = r.zipcode;

      byCamis.set(camis, entry);
    }

    // finalize unique restaurants
    allRestaurants = Array.from(byCamis.values()).map(v => ({
      camis: v.camis,
      dba: v.dba,
      building: v.building,
      street: v.street,
      boro: v.boro,
      zipcode: v.zipcode,
      cuisine_description: v.cuisine_description,
      // keep grade fields only if you still use them; otherwise remove from UI
      grade: v.grade || null,
      inspection_date: v.latestDate ? v.latestDate.toISOString().slice(0,10) : null,
      latitude: v.lat,
      longitude: v.lon,
      // compact history (dates only; feel free to drop if you don‚Äôt need)
      date_history: Array.from(v.dates).sort().reverse()
    }));

    console.log(`Loaded ${allRestaurants.length} unique, cleaned restaurants`);
    return true;
  } catch (e) {
    console.error('Data fetch error:', e);
    showError('Failed to load data. Refresh page.');
    return false;
  }
}

    function initMap() {
      map = L.map('map').setView([40.7128, -74.0060], 11);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CartoDB',
        maxZoom: 19,
        subdomains: 'abcd'
      }).addTo(map);
  
      markersLayer = L.featureGroup();
  
      // Disable spiderfy animations on cluster click; just zoom to bounds
      clusterGroup = L.markerClusterGroup({
        spiderfyOnEveryClick: false,
        spiderfyOnMaxZoom: false,
        zoomToBoundsOnClick: true,
        showCoverageOnHover: false,
        disableClusteringAtZoom: 16
      });
  
      map.addLayer(markersLayer);
      map.addLayer(clusterGroup);
    }
  
    function gradeHistoryLine(history) {
      if (!history || history.length === 0) return '';
      // compact "A (2024-05-10) ‚Üí B (2023-11-02) ‚Üí A (2022-06-01)"
      const items = history.slice(0, 6).map(h => `${h.grade} (${h.date})`);
      const tail = history.length > 6 ? ' ‚Üí ‚Ä¶' : '';
      return items.join(' ‚Üí ') + tail;
    }
  
    function createMarker(r, isSelected = false) {
      const radius = isSelected ? 10 : 6;
      const marker = L.circleMarker([r.latitude, r.longitude], {
        radius: radius,
        fillColor: isSelected ? '#3b82f6' : (gradeColors[r.grade] || '#94a3b8'),
        color: '#fff',
        weight: isSelected ? 2.5 : 1.5,
        opacity: 1,
        fillOpacity: 0.8,
        className: isSelected ? 'marker-highlight' : ''
      });
      const gUrl = `https://www.google.com/maps/search/${encodeURIComponent(r.dba + ' ' + r.building + ' ' + r.street)}`;
      const address = `${r.building} ${r.street}${r.zipcode ? ', ' + r.zipcode : ''}`;
      const gradeClass = r.grade ? `grade-${String(r.grade).toLowerCase()}` : '';
  
      const hist = gradeHistoryLine(r.grade_history);
      const inspected = r.grade_date || r.inspection_date;
  
      const p = `
        <div style="width:260px; color: #e2e8f0;">
          <div class="popup-name">${r.dba}</div>
          <div class="popup-info">${address}</div>
          <div class="popup-info"><strong>Cuisine:</strong> ${r.cuisine_description}</div>
          <div class="popup-info"><strong>Borough:</strong> ${r.boro}</div>
          ${r.grade ? `<div class="popup-grade ${gradeClass}">Grade ${r.grade}</div>` : ''}
          ${inspected ? `<div class="popup-info"><strong>Latest:</strong> ${inspected}</div>` : ''}
          ${hist ? `<div class="popup-info"><strong>Grade history:</strong><br>${hist}</div>` : ''}
          <a href="${gUrl}" target="_blank" class="popup-link">View on Google Maps</a>
        </div>`;
      marker.bindPopup(p);
      marker.on('click', () => selectRestaurant(r));
      // Store marker reference
      const markerKey = `${r.camis}`;
      if (!restaurantMarkers.has(markerKey)) {
        restaurantMarkers.set(markerKey, marker);
      }
      return marker;
    }
  
    function selectRestaurant(restaurant) {
      selectedRestaurant = restaurant;
      selectedIndex = filteredRestaurants.findIndex(r => r.camis === restaurant.camis);
  
      updateSelectedPanel();
      updateMap();
      updateRestaurantList();
      updateNavControls();
  
      map.setView([restaurant.latitude, restaurant.longitude], 16);
      document.getElementById('selectedPanel').classList.add('visible');
    }
  
    function updateSelectedPanel() {
      if (!selectedRestaurant) return;
      const panel = document.getElementById('selectedPanel');
      const content = document.getElementById('selectedContent');
      const gUrl = `https://www.google.com/maps/search/${encodeURIComponent(selectedRestaurant.dba + ' ' + selectedRestaurant.building + ' ' + selectedRestaurant.street)}`;
      const address = `${selectedRestaurant.building} ${selectedRestaurant.street}${selectedRestaurant.zipcode ? ', ' + selectedRestaurant.zipcode : ''}`;
      const gradeClass = selectedRestaurant.grade ? `grade-${String(selectedRestaurant.grade).toLowerCase()}` : '';
      const hist = gradeHistoryLine(selectedRestaurant.grade_history);
      const inspected = selectedRestaurant.grade_date || selectedRestaurant.inspection_date;
  
      // Adjust panel height if list view is visible
      panel.style.maxHeight = isListViewVisible ? '30vh' : '50vh';
  
      content.innerHTML = `
        <h2>${selectedRestaurant.dba}</h2>
        <div class="selected-info">
          <div class="selected-details">
            <div class="detail-item"><strong>Address:</strong> ${address}</div>
            <div class="detail-item"><strong>Cuisine:</strong> ${selectedRestaurant.cuisine_description}</div>
            <div class="detail-item"><strong>Borough:</strong> ${selectedRestaurant.boro}</div>
            ${selectedRestaurant.grade ? `<div class="popup-grade ${gradeClass}" style="display: inline-block; margin-top: 8px;">Grade ${selectedRestaurant.grade}</div>` : ''}
            ${inspected ? `<div class="detail-item"><strong>Latest:</strong> ${inspected}</div>` : ''}
            ${hist ? `<div class="detail-item"><strong>Grade history:</strong> ${hist}</div>` : ''}
          </div>
          <div class="selected-actions">
            <a href="${gUrl}" target="_blank" class="btn btn-primary" style="text-decoration: none; display: inline-block; text-align: center;">üìç View on Google Maps</a>
          </div>
        </div>
      `;
    }
  
    function updateRestaurantList() {
      const list = document.getElementById('restaurantList');
      if (!isListViewVisible) {
        list.classList.remove('visible');
        return;
      }
  
      list.innerHTML = '';
      filteredRestaurants.forEach((r, idx) => {
        const card = document.createElement('div');
        card.className = `restaurant-card ${selectedRestaurant && r.camis === selectedRestaurant.camis ? 'selected' : ''}`;
        card.innerHTML = `
          <h3>${r.dba}</h3>
          <div class="card-info">${r.cuisine_description}</div>
          <div class="card-info">${r.boro}${r.zipcode ? ' ‚Ä¢ ' + r.zipcode : ''}</div>
          ${r.grade ? `<div class="popup-grade grade-${String(r.grade).toLowerCase()}" style="display: inline-block; margin-top: 8px;">${r.grade}</div>` : ''}
        `;
        card.addEventListener('click', () => selectRestaurant(r));
        list.appendChild(card);
      });
      list.classList.add('visible');
    }
  
    function updateNavControls() {
      const navControls = document.getElementById('navControls');
      if (filteredRestaurants.length > 1 && selectedRestaurant) {
        navControls.classList.remove('hidden');
        document.getElementById('prevBtn').disabled = selectedIndex === 0;
        document.getElementById('nextBtn').disabled = selectedIndex === filteredRestaurants.length - 1;
      } else {
        navControls.classList.add('hidden');
      }
    }
  
    function navigateRestaurants(direction) {
      if (selectedIndex === -1 || filteredRestaurants.length === 0) return;
      const newIndex = direction === 'next' ? selectedIndex + 1 : selectedIndex - 1;
      if (newIndex >= 0 && newIndex < filteredRestaurants.length) {
        selectRestaurant(filteredRestaurants[newIndex]);
      }
    }
  
    function buildCuisineCheckboxes() {
      const counts = {};
      allRestaurants.forEach(r => {
        const cuisine = (r.cuisine_description || 'Unknown').trim();
        if (cuisine) counts[cuisine] = (counts[cuisine] || 0) + 1;
      });
  
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  
      const container = document.getElementById('cuisineCheckboxes');
      container.innerHTML = '';
  
      sorted.forEach(([cuisine, count]) => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `cuisine-${cuisine.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}`;
        cb.value = cuisine;
        cb.className = 'cuisine-checkbox';
        const lbl = document.createElement('label');
        lbl.htmlFor = cb.id;
        lbl.textContent = `${cuisine} (${count})`;
        div.appendChild(cb);
        div.appendChild(lbl);
        container.appendChild(div);
      });
    }
  
    function buildBoroughCheckboxes() {
      const container = document.getElementById('boroughCheckboxes');
      boroughs.forEach(b => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `borough-${b}`;
        cb.value = b;
        cb.className = 'borough-checkbox';
        const lbl = document.createElement('label');
        lbl.htmlFor = `borough-${b}`;
        lbl.textContent = b;
        div.appendChild(cb);
        div.appendChild(lbl);
        container.appendChild(div);
      });
    }
  
    function applyFilters() {
      const search = document.getElementById('search').value.toLowerCase();
      const locationRaw = document.getElementById('locationSearch').value;
      const resolved = resolveLocationToZips(locationRaw); // {name, zips} or null

      const cuisines = Array.from(document.querySelectorAll('.cuisine-checkbox:checked')).map(cb => cb.value);
      const grades = Array.from(document.querySelectorAll('.grade-checkbox:checked')).map(cb => cb.value);
      const boros = Array.from(document.querySelectorAll('.borough-checkbox:checked')).map(cb => cb.value);

      filteredRestaurants = allRestaurants.filter(r => {
        const matchesSearch = !search || r.dba.toLowerCase().includes(search);

        let matchesLocation = true;
        if (locationRaw && resolved) {
          matchesLocation = r.zipcode && resolved.zips.includes(String(r.zipcode));
        } else if (locationRaw && !resolved) {
          // Fallback to fuzzy address text if not a known neighborhood/zip
          const loc = locationRaw.toLowerCase();
          matchesLocation =
            (r.zipcode && r.zipcode.toString().toLowerCase().includes(loc)) ||
            (r.street && r.street.toLowerCase().includes(loc)) ||
            (r.building && r.building.toLowerCase().includes(loc)) ||
            ((r.building + ' ' + r.street).toLowerCase().includes(loc));
        }

        const matchesCuisine = cuisines.length === 0 || cuisines.includes(r.cuisine_description);
        const matchesGrade = grades.length === 0 || (r.grade && grades.includes(r.grade));
        const matchesBoro = boros.length === 0 || boros.includes(r.boro);

        return matchesSearch && matchesLocation && matchesCuisine && matchesGrade && matchesBoro;
      });

      // Stash the resolved location for UI message
      window.__lastResolvedLocation = resolved || null;

      updateMap();
      updateResultsCount();
    }

    function updateMap() {
      markersLayer.clearLayers();
      clusterGroup.clearLayers();
      restaurantMarkers.clear();
  
      if (isHeatmapMode) {
        if (heatmapLayer) map.removeLayer(heatmapLayer);
        const data = filteredRestaurants.map(r => [r.latitude, r.longitude, 1]);
        heatmapLayer = L.heatLayer(data, {
          radius: 25, blur: 15, maxZoom: 17,
          gradient: { 0.2: '#2563eb', 0.4: '#10b981', 0.6: '#f59e0b', 0.8: '#ef4444', 1: '#7c2d12' }
        });
        map.addLayer(heatmapLayer);
      } else {
        if (heatmapLayer) map.removeLayer(heatmapLayer);
        const markers = filteredRestaurants.map(r => {
          const isSelected = selectedRestaurant && r.camis === selectedRestaurant.camis;
          return createMarker(r, isSelected);
        });
        if (isClusteringEnabled) {
          markers.forEach(m => clusterGroup.addLayer(m));
        } else {
          markers.forEach(m => markersLayer.addLayer(m));
        }
        if (markers.length > 0 && !selectedRestaurant) {
          const g = new L.featureGroup(markers);
          map.fitBounds(g.getBounds(), { padding: [50, 50] });
        }
      }
    }
  
    function updateResultsCount() {
      const el = document.getElementById('resultsCount');
      const res = window.__lastResolvedLocation;
      if (res && res.zips && res.zips.length) {
        el.textContent = `Showing ${filteredRestaurants.length.toLocaleString()} restaurants in ${res.name} (ZIPs: ${res.zips.join(', ')})`;
      } else {
        el.textContent = `Showing ${filteredRestaurants.length.toLocaleString()} restaurants`;
      }
    }
  
    function clearFilters() {
      document.getElementById('search').value = '';
      document.getElementById('locationSearch').value = '';
      document.querySelectorAll('.cuisine-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('.grade-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('.borough-checkbox').forEach(cb => cb.checked = false);
      closeSelectedPanel();
      applyFilters();
    }
  
    function chooseRandom() {
      if (filteredRestaurants.length === 0) {
        showError('No restaurants match your filters. Try clearing filters first.');
        return;
      }
      const randomIndex = Math.floor(Math.random() * filteredRestaurants.length);
      const randomRestaurant = filteredRestaurants[randomIndex];
      selectRestaurant(randomRestaurant);
    }
  
    function toggleListView() {
      isListViewVisible = !isListViewVisible;
      document.getElementById('listViewToggle').classList.toggle('active', isListViewVisible);
      updateRestaurantList();
    }
  
    function closeSelectedPanel() {
      document.getElementById('selectedPanel').classList.remove('visible');
      selectedRestaurant = null;
      selectedIndex = -1;
      updateMap();
      updateRestaurantList();
      updateNavControls();
    }
  
    function toggleHeatmap() {
      isHeatmapMode = !isHeatmapMode;
      document.getElementById('markersToggle').classList.toggle('active', !isHeatmapMode);
      document.getElementById('heatmapToggle').classList.toggle('active', isHeatmapMode);
      updateMap();
    }
  
    function toggleClustering() {
      isClusteringEnabled = !isClusteringEnabled;
      document.getElementById('clusteringToggle').classList.toggle('active');
      if (!isHeatmapMode) updateMap();
    }
  
    function toggleFilterPanel() {
      const panel = document.getElementById('filterPanel');
      panel.classList.toggle('collapsed');
    }

    function filterCuisines(searchTerm) {
      const term = searchTerm.toLowerCase();
      const checkboxes = document.querySelectorAll('#cuisineCheckboxes .checkbox-item');
      checkboxes.forEach(item => {
        const label = item.querySelector('label');
        if (label) {
          const cuisineName = label.textContent.toLowerCase();
          item.style.display = cuisineName.includes(term) ? 'flex' : 'none';
        }
      });
    }

    // --- Analytics Functions ---
    function toggleAnalyticsSidebar() {
      const sidebar = document.getElementById('analyticsSidebar');
      const toggle = document.getElementById('analyticsToggle');
      console.log('Toggle analytics:', {sidebar: !!sidebar, toggle: !!toggle});
      if (sidebar) sidebar.classList.toggle('visible');
      if (toggle) toggle.classList.toggle('active');
    }

    function generateAnalytics(restaurants, searchQuery) {
      if (!restaurants || restaurants.length === 0) {
        return '<div style="padding: 20px; color: #94a3b8;">No data to display</div>';
      }

      const resolved = resolveLocationToZips(searchQuery);
      const searchType = resolved ? 'location' : 'cuisine'; // Could also detect chain names

      let html = '';

      if (searchType === 'location') {
        html = generateLocationAnalytics(restaurants, resolved);
      } else {
        html = generateCuisineAnalytics(restaurants, searchQuery);
      }

      return html;
    }

    function generateLocationAnalytics(restaurants, location) {
      // Cuisine breakdown
      const cuisineCount = {};
      restaurants.forEach(r => {
        cuisineCount[r.cuisine_description] = (cuisineCount[r.cuisine_description] || 0) + 1;
      });

      const sortedCuisines = Object.entries(cuisineCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      // Grade distribution
      const gradeCount = {};
      restaurants.forEach(r => {
        if (r.grade) gradeCount[r.grade] = (gradeCount[r.grade] || 0) + 1;
      });

      const gradeOrder = ['A', 'B', 'C'];
      const sortedGrades = gradeOrder.map(g => [g, gradeCount[g] || 0]).filter(x => x[1] > 0);

      const totalRestaurants = restaurants.length;
      const cuisineCount2 = new Set(restaurants.map(r => r.cuisine_description)).size;
      const avgGrade = restaurants.filter(r => r.grade).length > 0
        ? ((restaurants.filter(r => r.grade === 'A').length * 3 + restaurants.filter(r => r.grade === 'B').length * 2 + restaurants.filter(r => r.grade === 'C').length * 1) / restaurants.filter(r => r.grade).length).toFixed(1)
        : 'N/A';

      return `
        <div class="stat-card">
          <h4>üìä ${location.name}</h4>
          <div class="stat-value">${totalRestaurants}</div>
          <div class="stat-label">Total Restaurants</div>
        </div>

        <div class="stat-card">
          <h4>üçΩÔ∏è Cuisine Variety</h4>
          <div class="stat-value">${cuisineCount2}</div>
          <div class="stat-label">Different Cuisines</div>
        </div>

        <div class="chart-container">
          <h4>Top Cuisines</h4>
          <div class="bar-chart">
            ${(() => {
              const maxCuisine = Math.max(...sortedCuisines.map(c => c[1]), 1);
              return sortedCuisines.map(([cuisine, count]) => {
                const barWidth = ((count / maxCuisine) * 100).toFixed(0);
                const percent = ((count / totalRestaurants) * 100).toFixed(1);
                return `
                  <div class="bar-item">
                    <div class="bar-label">${cuisine}</div>
                    <div class="bar" style="width: ${barWidth}%;">
                      <div class="bar-value">${percent}%</div>
                    </div>
                  </div>
                `;
              }).join('');
            })()}
          </div>
        </div>

        <div class="chart-container">
          <h4>Grade Distribution</h4>
          <div class="bar-chart">
            ${(() => {
              const maxGrade = Math.max(...sortedGrades.map(g => g[1]), 1);
              return sortedGrades.map(([grade, count]) => {
                const barWidth = ((count / maxGrade) * 100).toFixed(0);
                const percent = ((count / totalRestaurants) * 100).toFixed(1);
                const gradeColor = grade === 'A' ? '#10b981' : grade === 'B' ? '#f59e0b' : '#ef4444';
                return `
                  <div class="bar-item">
                    <div class="bar-label">Grade ${grade}</div>
                    <div class="bar" style="background: linear-gradient(90deg, ${gradeColor}, ${gradeColor}dd); width: ${barWidth}%;">
                      <div class="bar-value">${percent}%</div>
                    </div>
                  </div>
                `;
              }).join('');
            })()}
          </div>
        </div>
      `;
    }

    function generateCuisineAnalytics(restaurants, cuisineQuery) {
      const cuisineFilter = cuisineQuery.toLowerCase();
      const boroughCount = {};
      const gradeCount = {};

      restaurants.forEach(r => {
        if (r.cuisine_description.toLowerCase().includes(cuisineFilter)) {
          boroughCount[r.boro] = (boroughCount[r.boro] || 0) + 1;
          if (r.grade) gradeCount[r.grade] = (gradeCount[r.grade] || 0) + 1;
        }
      });

      const totalCuisine = Object.values(boroughCount).reduce((a, b) => a + b, 0);
      const sortedBoroughs = Object.entries(boroughCount).sort((a, b) => b[1] - a[1]);
      const gradeOrder = ['A', 'B', 'C'];
      const sortedGrades = gradeOrder.map(g => [g, gradeCount[g] || 0]).filter(x => x[1] > 0);

      return `
        <div class="stat-card">
          <h4>üçú ${cuisineFilter.charAt(0).toUpperCase() + cuisineFilter.slice(1)}</h4>
          <div class="stat-value">${totalCuisine}</div>
          <div class="stat-label">Restaurants Found</div>
        </div>

        <div class="chart-container">
          <h4>By Borough</h4>
          <div class="bar-chart">
            ${(() => {
              const maxBorough = Math.max(...sortedBoroughs.map(b => b[1]), 1);
              return sortedBoroughs.map(([borough, count]) => {
                const barWidth = ((count / maxBorough) * 100).toFixed(0);
                const percent = ((count / totalCuisine) * 100).toFixed(1);
                return `
                  <div class="bar-item">
                    <div class="bar-label">${borough}</div>
                    <div class="bar" style="width: ${barWidth}%;">
                      <div class="bar-value">${percent}%</div>
                    </div>
                  </div>
                `;
              }).join('');
            })()}
          </div>
        </div>

        <div class="chart-container">
          <h4>Quality Grades</h4>
          <div class="bar-chart">
            ${(() => {
              const maxGradeCount = Math.max(...sortedGrades.map(g => g[1]), 1);
              return sortedGrades.map(([grade, count]) => {
                const barWidth = ((count / maxGradeCount) * 100).toFixed(0);
                const percent = ((count / totalCuisine) * 100).toFixed(1);
                const gradeColor = grade === 'A' ? '#10b981' : grade === 'B' ? '#f59e0b' : '#ef4444';
                return `
                  <div class="bar-item">
                    <div class="bar-label">Grade ${grade}</div>
                    <div class="bar" style="background: linear-gradient(90deg, ${gradeColor}, ${gradeColor}dd); width: ${barWidth}%;">
                      <div class="bar-value">${percent}%</div>
                    </div>
                  </div>
                `;
              }).join('');
            })()}
          </div>
        </div>
      `;
    }

    function updateAnalytics() {
      // Show analytics as long as there are filtered results - regardless of what filter was applied
      if (filteredRestaurants.length === 0) {
        document.getElementById('analyticsContent').innerHTML = `
          <div style="padding: 20px; text-align: center; color: #94a3b8;">
            No restaurants match your filters
          </div>
        `;
        return;
      }

      // Determine which search type to use for analytics
      const locationSearch = document.getElementById('locationSearch').value;
      const cuisineSearch = document.getElementById('cuisineSearch').value;
      const searchQuery = locationSearch || cuisineSearch;

      console.log('updateAnalytics called:', {locationSearch, cuisineSearch, searchQuery, numRestaurants: filteredRestaurants.length});

      console.log('Generating analytics...');
      const analytics = generateAnalytics(filteredRestaurants, searchQuery);
      document.getElementById('analyticsContent').innerHTML = analytics;
    }

    async function init() {
      initMap();
      buildBoroughCheckboxes();
      buildNeighborhoodDatalist();
      const loaded = await fetchData();
      if (loaded) {
        buildCuisineCheckboxes(); // Build after data is loaded
        filteredRestaurants = [...allRestaurants];
        updateMap();
        updateResultsCount();

        document.getElementById('search').addEventListener('input', debounce(() => {
          applyFilters();
          updateAnalytics();
        }, 300));
        document.getElementById('locationSearch').addEventListener('input', debounce(() => {
          applyFilters();
          updateAnalytics();
        }, 300));

        // event delegation for dynamically created cuisine checkboxes
        document.getElementById('cuisineCheckboxes').addEventListener('change', (e) => {
          if (e.target.classList.contains('cuisine-checkbox')) {
            applyFilters();
            updateAnalytics();
          }
        });

        // Cuisine search filter
        document.getElementById('cuisineSearch').addEventListener('input', (e) => {
          filterCuisines(e.target.value);
          applyFilters();
          updateAnalytics();
        });

        document.querySelectorAll('.grade-checkbox').forEach(cb => cb.addEventListener('change', () => {
          applyFilters();
          updateAnalytics();
        }));
        document.querySelectorAll('.borough-checkbox').forEach(cb => cb.addEventListener('change', () => {
          applyFilters();
          updateAnalytics();
        }));

        // Filter panel controls
        document.getElementById('filterToggle').addEventListener('click', toggleFilterPanel);
        document.getElementById('filterClose').addEventListener('click', toggleFilterPanel);

        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        document.getElementById('randomBtn').addEventListener('click', chooseRandom);
        document.getElementById('heatmapToggle').addEventListener('click', toggleHeatmap);
        document.getElementById('markersToggle').addEventListener('click', toggleHeatmap);
        document.getElementById('clusteringToggle').addEventListener('click', toggleClustering);
        document.getElementById('listViewToggle').addEventListener('click', toggleListView);
        document.getElementById('closePanel').addEventListener('click', closeSelectedPanel);
        document.getElementById('prevBtn').addEventListener('click', () => navigateRestaurants('prev'));
        document.getElementById('nextBtn').addEventListener('click', () => navigateRestaurants('next'));

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (selectedRestaurant && !e.target.matches('input, textarea')) {
            if (e.key === 'ArrowLeft') navigateRestaurants('prev');
            if (e.key === 'ArrowRight') navigateRestaurants('next');
            if (e.key === 'Escape') closeSelectedPanel();
          }
        });
      }
      document.getElementById('loading').classList.add('hidden');

      // Analytics controls - bind these AFTER DOM is ready
      const analyticsBtn = document.getElementById('analyticsToggle');
      const analyticsClose = document.getElementById('analyticsClose');
      if (analyticsBtn) analyticsBtn.addEventListener('click', toggleAnalyticsSidebar);
      if (analyticsClose) analyticsClose.addEventListener('click', toggleAnalyticsSidebar);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  
</body>
</html>
